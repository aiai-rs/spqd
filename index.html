<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æš—ç½‘ | åŒ¿åäº¤æ˜“å¹³å°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            purple: '#6366f1',
                        }
                    },
                    boxShadow: {
                        'tech': '0 4px 20px -2px rgba(59, 130, 246, 0.15)',
                        'tech-hover': '0 10px 25px -5px rgba(59, 130, 246, 0.25)',
                    }
                }
            }
        }
    </script>
<style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8fafc;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            /* [æ–°å¢] å¼ºåˆ¶ç¦æ­¢æ¨ªå‘æ»šåŠ¨ï¼Œä¿®å¤ç™½è¾¹å’Œæ»‘åŠ¨é—®é¢˜ */
            overflow-x: hidden;
            width: 100%;
        }

        .btn-gradient {
            background: linear-gradient(90deg, #3b82f6 0%, #6366f1 100%);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transform: translateY(-1px);
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .nav-item {
            position: relative;
            white-space: nowrap;
        }
@media (max-width: 640px) {
            html { font-size: 14px; } /* ç¼©å°åŸºå‡†å­—ä½“ */
            .product-grid { gap: 10px !important; }
.p-4 { padding: 1rem !important; } /* å‡å°å†…è¾¹è· */
            
            /* [ä¿®æ”¹] å½“å±å¹•é«˜åº¦å˜å°ï¼ˆé”®ç›˜å¼¹å‡ºï¼‰æ—¶ï¼Œå°†å¯¼èˆªæ å¼ºåˆ¶å›ºå®šåœ¨é¡µé¢æœ€åº•éƒ¨ï¼Œä¸éšè—ï¼Œä¹Ÿä¸ä¼šé£˜åœ¨ä¸­é—´ */
            @media (max-height: 600px) {
                #mobile-bottom-nav {
                    position: absolute !important;
                    bottom: 0 !important;
                }
            }
        }
/* æ¶ˆæ¯åˆ—è¡¨åŠ¨ç”» */

        .font-fix {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif !important;
        }
        .captcha-display {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5em;
            font-weight: bold;
            color: #3b82f6;
            background: #f0f9ff;
            user-select: none;
        }

/* å®¢æœæ‚¬æµ®çª— */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
        }
        /* [ä¿®æ”¹] å®¢æœçª—å£æ”¹ä¸ºå…¨å±é®ç½©å¼¹çª—æ¨¡å¼ */
       .chat-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) !important; /* å¼ºåˆ¶å±…ä¸­ */
            width: 90%; 
            max-width: 400px;
            height: 70vh; /* é«˜åº¦è‡ªé€‚åº” */
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 101; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
            border: 1px solid #e2e8f0;
        }
        /* [æ–°å¢] é®ç½©å±‚èƒŒæ™¯ */
        .chat-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
        }

/* [æ–°å¢] ç§»åŠ¨ç«¯æ•´ä½“ç¼©æ”¾ä¼˜åŒ– */
        @media (max-width: 640px) {
            html { font-size: 14px; } /* ç¼©å°åŸºå‡†å­—ä½“ */
            .product-grid { gap: 10px !important; }
            .p-4 { padding: 1rem !important; } /* å‡å°å†…è¾¹è· */
        }

        /* [ä¿®å¤] å°†è¿™æ®µä»ä¸Šé¢çš„èŠ±æ‹¬å·é‡Œç§»å‡ºæ¥ï¼Œè§£å†³é”®ç›˜å¼¹å‡ºæ—¶å¯¼èˆªæ é®æŒ¡è¾“å…¥æ¡†çš„é—®é¢˜ */
        @media (max-height: 600px) {
            #mobile-bottom-nav, .chat-widget {
                display: none !important;
            }
        }

        /* [ä¿®å¤] å¼ºåˆ¶ç¦æ­¢ HTML å’Œ Body æ¨ªå‘æ»šåŠ¨ï¼Œå½»åº•è§£å†³ç™½è¾¹å’Œå·¦å³æ»‘åŠ¨ */
        html, body {
            overflow-x: hidden !important;
            width: 100%;
            max-width: 100vw;
        }

/* æ¶ˆæ¯åˆ—è¡¨åŠ¨ç”» */
.chat-msg {
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 18px;
    font-size: 14px;
    margin-bottom: 12px;
    word-wrap: break-word;
    line-height: 1.5;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    animation: msg-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* æ¶ˆæ¯å¼¹å‡ºåŠ¨ç”» */
}

@keyframes msg-pop {
    0% { opacity: 0; transform: translateY(10px) scale(0.95); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

.chat-msg.user {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.chat-msg.admin {
    background: #f8fafc;
    color: #1e293b;
    border: 1px solid #e2e8f0;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}
        
        /* è½®æ’­å›¾æŒ‰é’® */
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: 0.2s;
        }
        .carousel-btn:hover { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .carousel-btn.left { left: 10px; }
        .carousel-btn.right { right: 10px; }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-enter-active .modal-content, .modal-leave-active .modal-content { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-enter-from .modal-content, .modal-leave-to .modal-content { transform: scale(0.95); }

        /* æ–°å¢æ ·å¼ */
        .order-timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #ef4444;
        }
        
        .contact-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .contact-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .contact-btn.telegram {
            background: #0088cc;
            color: white;
        }
        
        .contact-btn.website {
            background: #10b981;
            color: white;
        }
        
        .contact-btn.email {
            background: #6366f1;
            color: white;
        }
        
        .contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            border: 2px solid #dc2626;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        
        .warning-text {
            color: #7f1d1d;
            font-weight: bold;
            text-align: center;
            letter-spacing: 0.5px;
        }
        
        /* è´­ç‰©è½¦å¾½ç«  */
        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ä½™é¢æ”¯ä»˜æ ·å¼ */
        .balance-payment {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .balance-payment:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        /* å•†å“ç½‘æ ¼å¸ƒå±€è°ƒæ•´ */
        @media (max-width: 640px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* å¯¼èˆªæ ä¼˜åŒ– */
        @media (max-width: 768px) {
            .nav-container {
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-items {
                display: flex;
                flex-wrap: nowrap;
                min-width: max-content;
            }
            
            .nav-item {
                padding: 0 12px;
                font-size: 14px;
            }
        }
      @media (max-width: 768px) {
            .chat-widget {
                bottom: 111px !important;
            }
        }

        /* [æ–°å¢] å…¨å±€æš´åŠ›éšè—æ»šåŠ¨æ¡ï¼šè¿™ä¼šè®©æ•´ä¸ªç½‘ç«™ï¼ˆåŒ…æ‹¬å¼¹çª—ã€ä¸»é¡µï¼‰çš„ç°è‰²æ¡å½»åº•æ¶ˆå¤±ï¼Œä½†ä¾ç„¶å¯ä»¥æ»‘åŠ¨ */
        ::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
            background: transparent !important;
        }
        
        /* å…¼å®¹ Firefox å’Œ IE */
html, body, div, section, main, ul, li {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }
    </style>

<link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f8fafc">
    
    <link rel="icon" href="icon.jpg"> 
    <link rel="shortcut icon" href="icon.jpg"> 

    <link rel="apple-touch-icon" href="icon.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å°æš—ç½‘">
    
    <style>
        #app-loading { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { w-12 h-12 border-4 border-brand-200 border-t-brand-500 rounded-full animate-spin }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col bg-slate-50">

<div id="app" class="flex flex-col h-full" v-cloak>
    <div id="app-loading" v-if="loading && !products.length">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <div class="text-slate-400 text-sm font-bold tracking-widest">XAW LOADING...</div>
    </div>
    
    <nav class="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm pt-[env(safe-area-inset-top)]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 gap-4">
<div class="flex items-center gap-3 cursor-pointer flex-shrink-0" @click="setView('home')">
    <div class="relative group">
       <div class="w-11 h-11 rounded-full bg-black flex items-center justify-center text-[#00ff41] shadow-[0_0_15px_rgba(0,255,65,0.4)] border border-[#00ff41]/60 transition-all duration-300 group-hover:scale-110">
    <i class="ri-spy-fill text-2xl"></i>
</div>
        <div class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>
    </div>
    
    <div class="flex flex-col justify-center">
        <span class="font-black text-lg leading-none text-slate-900 font-mono tracking-tighter" style="font-family: 'Courier New', monospace;">
            å°æš—ç½‘
        </span>
        <span class="mt-1 inline-block bg-slate-900 text-[#00ff42] text-[10px] font-bold px-1 rounded leading-tight tracking-wider font-mono w-max">
            {{ siteConfig.domainText }}
        </span>
    </div>
</div>

                <div class="hidden md:flex flex-1 overflow-x-auto scrollbar-hide items-center gap-6 px-2 nav-container">
                    <div class="flex items-center gap-6 nav-items">
                        <a @click="setView('home')" :class="['nav-item cursor-pointer text-sm font-medium transition hover:text-brand-500 flex-shrink-0', view==='home' && filterCat==='all' ? 'active' : 'text-slate-600']">é¦–é¡µ</a>
                        <a @click="setView('products')" :class="['nav-item cursor-pointer text-sm font-medium transition hover:text-brand-500 flex-shrink-0', view==='home' && filterCat!=='all' ? 'active' : 'text-slate-600']">å•†å“</a>
                        <a @click="checkLoginAndGo('orders_page')" :class="['nav-item cursor-pointer text-sm font-medium transition hover:text-brand-500 flex-shrink-0', view==='orders_page' ? 'active' : 'text-slate-600']">è®¢å•</a>
                        <a @click="setView('hiring')" :class="['nav-item cursor-pointer text-sm font-medium transition hover:text-brand-500 flex-shrink-0', view==='hiring' ? 'active' : 'text-slate-600']">æ‹›è˜</a>
                        <a @click="checkLoginAndGo('profile')" :class="['nav-item cursor-pointer text-sm font-medium transition hover:text-brand-500 flex-shrink-0', view==='profile' ? 'active' : 'text-slate-600']">ä¸ªäººä¸­å¿ƒ</a>
                    </div>
                </div>

                <div class="flex items-center gap-3 flex-shrink-0">
                    <!-- è´­ç‰©è½¦æŒ‰é’® -->
                    <div class="relative" v-if="user.id">
                        <button @click="viewCart" class="text-slate-600 hover:text-brand-500 transition relative">
                            <i class="ri-shopping-cart-2-line text-xl"></i>
                            <span v-if="cartItems.length > 0" class="cart-badge">{{ cartItems.length }}</span>
                        </button>
                    </div>
                    
                    <template v-if="!user.id">
                        <button @click="openAuth('login')" class="px-3 sm:px-5 py-1.5 text-xs sm:text-sm font-medium text-brand-500 border border-brand-500 rounded-md hover:bg-brand-50 transition flex items-center gap-1 whitespace-nowrap">
                            ç™»å½•
                        </button>
                        <button @click="openAuth('register')" class="btn-gradient px-3 sm:px-5 py-1.5 text-xs sm:text-sm font-medium text-white rounded-md shadow-lg shadow-brand-500/30 flex items-center gap-1 whitespace-nowrap">
                            æ³¨å†Œ
                        </button>
                    </template>
                    <template v-else>
                        <div class="flex items-center gap-2 bg-slate-100 rounded-full pl-1 pr-3 py-1 cursor-pointer hover:bg-slate-200 transition" @click="setView('profile')">
                            <div class="w-6 h-6 sm:w-7 sm:h-7 bg-brand-500 rounded-full text-white flex items-center justify-center text-xs">
                                {{ user.contact.charAt(0).toUpperCase() }}
                            </div>
                            <span class="text-xs sm:text-sm font-medium text-slate-700 truncate max-w-[60px] sm:max-w-[80px]">{{ user.contact }}</span>
                        </div>
                        <button @click="logout" class="text-slate-400 hover:text-red-500 transition" title="é€€å‡º">
                            <i class="ri-logout-circle-r-line text-lg sm:text-xl"></i>
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow pt-20 pb-24 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto w-full">
        
<div v-if="view === 'home'" class="mb-5 animate-fade-in-up">
            <div class="bg-gradient-to-r from-blue-50 via-white to-indigo-50 rounded-2xl p-5 shadow-sm border border-brand-100/60 relative overflow-hidden">
                <div class="relative z-10">
                    
                    <div v-if="settings.announcement" class="flex items-center gap-2 mb-4 bg-brand-50/50 p-2 rounded-lg border border-brand-100/50">
                        <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-500 text-white leading-none flex-shrink-0">å…¬å‘Š</span>
                        <marquee scrollamount="3" class="text-sm font-medium text-brand-600 tracking-wide">
                            {{ settings.announcement }}
                        </marquee>
                    </div>

                    <div class="text-center space-y-3 py-2">
                        <div class="flex items-center justify-center gap-2 mb-1">
                            
                            <h3 class="text-lg font-black text-slate-800 tracking-[4px]" style="text-shadow: 0 1px 1px rgba(0,0,0,0.05);">
                                æ¬¢è¿æ¥åˆ°å°æš—ç½‘
                            </h3>
                            
                        </div>
                        
                        <p class="text-sm text-slate-500 font-medium tracking-[2px]">
                            è¿™é‡Œä»€ä¹ˆéƒ½æœ‰ï¼Œåªæ˜¯æœ‰æ—¶å€™æ‡’å¾—ä¸Šæ¶è€Œå·²
                        </p>
                        
                        <p class="text-sm text-slate-500 font-medium tracking-[2px]">
                            è¦æœ‰ä»€ä¹ˆéƒ½å¯ä»¥å’¨è¯¢åœ¨çº¿å®¢æœ
                        </p>
                        
                        <div class="mt-4 inline-block bg-red-50 border border-red-100 px-4 py-2 rounded-lg">
                            <p class="text-xs font-bold text-red-500 tracking-[1px] flex items-center gap-1">
                                <i class="ri-alarm-warning-fill"></i> æ³¨æ„ï¼æœ¬ç½‘å€æ‰€æœ‰æ•°æ®åªä¿ç•™ä¸‰å¤©è¯·è‡ªè¡Œä¿ç•™æ•°æ®
                            </p>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div v-if="view === 'home'" class="animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
                <h2 class="text-2xl font-bold text-slate-800 tracking-tight self-start md:self-center">
                    {{ filterCat === 'all' ? 'ç²¾é€‰å•†å“' : filterCat }}
                </h2>
                <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                    <div class="relative group">
                        <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-brand-500 transition"></i>
                        <input v-model="searchQuery" type="text" placeholder="æœç´¢å•†å“..." class="w-full md:w-64 bg-white border border-slate-200 rounded-full py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:border-brand-500 focus:ring-2 focus:ring-brand-50 transition shadow-sm">
                    </div>
<div class="flex flex-wrap gap-3 w-full md:w-auto">
                        <button @click="filterCat = 'all'" 
                            :class="filterCat === 'all' ? 'btn-gradient text-white shadow-lg shadow-indigo-500/20 ring-2 ring-indigo-50' : 'bg-white text-slate-500 hover:text-slate-800 border border-slate-200 hover:border-slate-300'" 
                            class="px-6 py-2.5 rounded-full text-xs font-bold transition-all duration-300 transform hover:-translate-y-0.5 active:scale-95"
                        >
                            å…¨éƒ¨
                        </button>

                        <button v-for="cat in categories" :key="cat" @click="filterCat = cat" 
                            :class="filterCat === cat ? 'btn-gradient text-white shadow-lg shadow-indigo-500/20 ring-2 ring-indigo-50' : 'bg-white text-slate-500 hover:text-slate-800 border border-slate-200 hover:border-slate-300'" 
                            class="px-6 py-2.5 rounded-full text-xs font-bold transition-all duration-300 transform hover:-translate-y-0.5 active:scale-95"
                        >
                            {{ cat }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="loading" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div v-for="i in 6" :key="i" class="bg-white rounded-2xl p-4 shadow-sm h-80 animate-pulse">
                    <div class="bg-slate-200 h-40 rounded-xl mb-4"></div>
                    <div class="h-4 bg-slate-200 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                </div>
            </div>
            
            <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 product-grid">
                <div v-for="prod in filteredProducts" :key="prod.id" @click="openProductDetail(prod)" class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-tech-hover transition-all duration-300 group cursor-pointer border border-slate-100 flex flex-col h-full relative">
                    <div v-if="prod.is_pinned" class="absolute top-3 right-3 z-10 bg-gradient-to-r from-yellow-400 to-orange-400 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-md">HOT</div>
                    
                    <div class="aspect-[4/3] bg-slate-100 relative overflow-hidden">
                        <img v-if="getImgList(prod).length > 0" :src="getImgList(prod)[0]" class="w-full h-full object-cover group-hover:scale-110 transition duration-700" @error="handleImageError">
                        <div v-else class="w-full h-full flex flex-col items-center justify-center bg-slate-50">
    <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mb-2 shadow-inner">
        <i class="ri-spy-fill text-3xl text-slate-300"></i>
    </div>
    <span class="text-xs text-slate-400 font-bold tracking-widest opacity-70">æš‚æ— å›¾ç‰‡</span>
</div>
                        <div class="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <span class="bg-white/90 backdrop-blur text-slate-800 text-xs font-bold px-4 py-2 rounded-full shadow-lg transform translate-y-4 group-hover:translate-y-0 transition">æŸ¥çœ‹è¯¦æƒ…</span>
                        </div>
                    </div>

                    <div class="p-4 flex-grow flex flex-col">
                        <div class="mb-2">
                            <span class="text-[10px] text-brand-600 bg-brand-50 px-2 py-0.5 rounded-md font-medium">{{ prod.category }}</span>
                        </div>
                        <h3 class="text-base font-bold text-slate-800 mb-1 line-clamp-1 group-hover:text-brand-600 transition">{{ prod.name }}</h3>
                        <p class="text-slate-500 text-xs line-clamp-2 mb-4 flex-grow leading-relaxed">{{ prod.description }}</p>
                        
<div class="flex items-center justify-between mt-auto pt-3 border-t border-slate-50">
                            <div>
                                <span class="text-xs text-slate-400">ä»·æ ¼</span>
                                <div class="text-lg font-bold text-slate-800 font-mono">
                                    {{ parseFloat(prod.price) }} <span class="text-xs font-normal text-slate-500">USDT</span>
                                </div>
                                <div class="text-xs text-slate-400 font-medium">â‰ˆ Â¥{{ (prod.price * settings.rate).toFixed(2) }}äººæ°‘å¸</div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-slate-400 block mb-0.5">åº“å­˜</span>
                                <span :class="prod.stock > 0 ? 'text-emerald-500 bg-emerald-50' : 'text-red-500 bg-red-50'" class="px-2 py-0.5 rounded text-xs font-bold">
                                    {{ prod.stock > 0 ? prod.stock : 'å”®ç½„' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="!loading && filteredProducts.length === 0" class="text-center py-24">
                <div class="bg-slate-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ri-inbox-2-line text-4xl text-slate-300"></i>
                </div>
                <h3 class="text-slate-600 font-medium">æœªæ‰¾åˆ°ç›¸å…³å•†å“</h3>
                <p class="text-slate-400 text-sm mt-1">å°è¯•åˆ‡æ¢åˆ†ç±»æˆ–æœç´¢å…¶ä»–å…³é”®è¯</p>
            </div>
        </div>

<div v-if="view === 'hiring'" class="animate-fade-in max-w-2xl mx-auto pb-10">
            <div class="mb-8">
                <div class="bg-gradient-to-br from-white to-slate-50 rounded-3xl p-6 shadow-lg shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-brand-500/5 rounded-full blur-3xl -mr-16 -mt-16"></div>
                    
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-2xl bg-brand-50 text-brand-600 flex items-center justify-center shadow-sm">
                            <i class="ri-megaphone-fill text-xl"></i>
                        </div>
<div>
                            <h2 class="text-lg font-bold text-slate-800">å®˜æ–¹å…¬å‘Š</h2>
                            <p class="text-xs text-slate-400">æœ€æ–°å‘å¸ƒ Â· è¯·ä»”ç»†é˜…è¯»</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="space-y-3 text-sm text-slate-600 leading-relaxed">
                        <p>
                            ğŸ‘‹ æ¬¢è¿åŠ å…¥æˆ‘ä»¬ï¼æˆ‘æ˜¯ <span class="font-bold text-slate-800">{{ siteConfig.bossName }}</span>ã€‚æˆ‘æ˜¯è¯¥ç½‘ç«™çš„è€æ¿ã€‚
                        </p>
                        <p class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                            ç½‘ç«™é—®é¢˜è¯·è”ç³»è´Ÿè´£äºº <a href="https://t.me/rrss0" class="text-brand-600 font-bold hover:underline">@rrss0</a>ã€‚<br>
                            è´­ä¹°å•†å“è”ç³»åœ¨çº¿å®¢æœå°±è¡Œäº†ã€‚
                        </p>
                        <p>
                            åº”è˜æˆ–æŠ•è¯‰å’Œå•†åŠ¡åˆä½œç›´æ¥ç‚¹å‡»ä¸‹æ–¹çš„ <span class="text-brand-600 font-bold">è”ç³»{{ siteConfig.bossTitle }}</span>ã€‚<br>
                            æ²¡æœ‰Telegramä¹Ÿå°±æ˜¯é£æœºçš„ç‚¹å‡»ä¸‹æ–¹çš„ <span class="text-emerald-500 font-bold">æ‹›è˜å®˜ç½‘</span> å°±å¯ä»¥äº†ã€‚
                        </p>
                        <p class="font-medium text-slate-800">
                            æŠ•è¯‰/åº”è˜/å•†åŠ¡åˆä½œè¯·ç›´æ¥è”ç³»æˆ‘ï¼š<a :href="'https://t.me/' + siteConfig.contactId" class="text-brand-600 font-bold hover:underline">@{{ siteConfig.contactId }}</a>
                        </p>
                    </div>

                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-4 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <i class="ri-money-cny-box-fill text-6xl text-amber-500"></i>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-[10px] font-bold border border-amber-200">åˆä½œå…±èµ¢</span>
                                <h4 class="font-bold text-amber-800 text-sm">äººæ‰æ¨èè®¡åˆ’</h4>
                            </div>
                            <p class="text-xs text-amber-900/80 leading-relaxed font-medium">
                                ä»‹ç»èº«è¾¹çš„å…„å¼Ÿæœ‹å‹å…¥èŒï¼Œå³å¯è·å¾— <span class="text-red-500 font-black text-sm bg-white/50 px-1 rounded">3-4ä¸‡äººæ°‘å¸</span> ä½£é‡‘ï¼
                                <br>æ¬¢è¿æ‰‹é‡Œæœ‰ <span class="underline decoration-amber-400 decoration-2">äººåŠ›èµ„æº</span> çš„å…„å¼Ÿæ´½è°ˆåˆä½œï¼Œèµ„æºå˜ç°ã€‚
                            </p>
                        </div>
                    </div>

                    <div class="bg-red-50/80 border border-red-100 rounded-xl p-3.5 flex gap-3 items-start">
                            <i class="ri-shield-check-fill text-red-500 text-lg mt-0.5 shrink-0"></i>
                            <div class="text-xs text-red-700 leading-5">
                                <span class="font-bold block mb-1">é˜²éª—æŒ‡å—</span>
                                è®¤å‡†ç®¡ç†å‘˜ç”¨æˆ·åå‡ä¸º <span class="bg-white px-1.5 py-0.5 rounded text-red-600 font-mono font-bold border border-red-100">4å­—æ¯+1æ•°å­—</span> (å¦‚: rrss0, {{ siteConfig.contactId }})ã€‚è¯·å‹¿è½»ä¿¡ä»»ä½•æ¨¡ä»¿æˆ‘ä»¬çš„è´¦å·ï¼
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 pt-2">
                            <a :href="'https://t.me/' + siteConfig.contactId" target="_blank" class="flex items-center justify-center gap-2 bg-white border border-slate-200 py-2.5 rounded-xl text-sm font-bold text-slate-700 hover:border-brand-500 hover:text-brand-600 transition shadow-sm">
                                <i class="ri-telegram-fill text-[#0088cc] text-lg"></i> è”ç³»{{ siteConfig.bossName }}
                            </a>
                            <a href="https://HY88.Pro" target="_blank" class="flex items-center justify-center gap-2 bg-white border border-slate-200 py-2.5 rounded-xl text-sm font-bold text-slate-700 hover:border-brand-500 hover:text-brand-600 transition shadow-sm">
                                <i class="ri-global-line text-emerald-500 text-lg"></i> æ‹›è˜å®˜ç½‘
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-5">
                <div class="flex items-center justify-between px-2 mb-2">
                    <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-brand-500 rounded-full"></span>
                        æ­£åœ¨æ‹›è˜çš„å²—ä½
                    </h3>
                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded-md">{{ hiringList.length }} ä¸ªå²—ä½</span>
                </div>

                <div v-for="(job, idx) in hiringList" :key="idx" class="group bg-white rounded-3xl p-1 shadow-sm hover:shadow-md transition duration-300 border border-slate-100 relative overflow-hidden">
                    <div class="p-5 relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800 mb-1 flex items-center gap-2">
                                    {{ job.title }}
                                </h3>
                                <div class="flex gap-2 mt-2">
                                    <span class="text-[10px] text-slate-500 bg-slate-50 px-2 py-0.5 rounded border border-slate-100">å…¨èŒ/å…¼èŒ</span>
                                </div>
                            </div>
                            <div class="w-10 h-10 bg-brand-50 rounded-full flex items-center justify-center text-brand-600 group-hover:scale-110 transition">
                                <i class="ri-briefcase-4-line text-xl"></i>
                            </div>
                        </div>

                        <div class="mb-6">
                           <div class="bg-slate-50/50 rounded-2xl p-4 text-sm text-slate-600 leading-relaxed border border-slate-50">
                                <ul class="list-disc pl-4 space-y-1 marker:text-brand-300">
                                    <template v-for="(line, lIdx) in (job.content || '').split('\n')" :key="lIdx">
                                        <li v-if="line.trim()" class="pl-1">{{ line.trim() }}</li>
                                    </template>
                                </ul>
                            </div>
                        </div>

                        <div v-if="job.contact" class="flex items-center gap-3 pt-2">
                            <a :href="getTelegramLink(job.contact)" target="_blank" class="flex-1 btn-gradient text-white text-sm font-bold py-3 rounded-xl shadow-lg shadow-brand-500/20 hover:-translate-y-0.5 transition flex items-center justify-center gap-2">
                                <i class="ri-send-plane-fill"></i> ç«‹å³æ²Ÿé€š
                            </a>
                            <div class="px-4 py-3 bg-slate-50 text-slate-500 rounded-xl text-xs font-mono font-medium border border-slate-100 select-all">
                                @{{ job.contact }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-gradient-to-tl from-brand-50 to-transparent rounded-full opacity-50 group-hover:opacity-100 transition"></div>
                </div>

                <div v-if="hiringList.length === 0" class="text-center py-16">
                    <div class="bg-slate-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="ri-briefcase-line text-3xl text-slate-300"></i>
                    </div>
                    <p class="text-slate-400 text-sm">æš‚æ—¶æ²¡æœ‰æ‹›è˜èŒä½</p>
                </div>
            </div>
        </div>
<div v-if="view === 'profile'" class="animate-fade-in max-w-lg mx-auto pt-4">
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden relative mb-6">
                <div class="h-24 bg-brand-50"></div>
                
                <div class="px-6 pb-6 -mt-12 flex flex-col items-center text-center relative z-10">
                    <div class="w-24 h-24 bg-white rounded-full p-1 shadow-lg mb-3">
                        <div class="w-full h-full bg-slate-100 rounded-full flex items-center justify-center text-3xl font-bold text-brand-500">
                            {{ user.contact ? user.contact.charAt(0).toUpperCase() : 'U' }}
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-slate-800">{{ user.contact }}</h2>
                    <p class="text-xs text-slate-400 font-mono mt-1">UID: {{ user.uid || user.id }}</p>

                    <div class="w-full bg-slate-50 rounded-2xl p-6 mt-6 mb-6 relative">
                        <div class="text-sm text-slate-500 mb-2">è´¦æˆ·ä½™é¢</div>
                        <div class="text-3xl font-bold text-emerald-500 font-mono">
    {{ parseFloat(user.balance || 0).toFixed(2) }} <span class="text-sm text-slate-400 font-normal">USDT</span>
</div>
                        <div @click="openBalanceLogs" class="absolute top-6 right-6 text-slate-400 hover:text-brand-500 cursor-pointer flex items-center gap-1 text-xs bg-white px-2 py-1 rounded border border-slate-200">
                            <i class="ri-bill-line"></i> èµ„é‡‘æ˜ç»†
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 w-full">
                        <button @click="openRechargeModal" class="flex items-center justify-center gap-2 py-3.5 bg-emerald-50 text-emerald-600 rounded-xl font-bold hover:bg-emerald-100 transition">
                            <i class="ri-wallet-3-fill"></i> å……å€¼
                        </button>
                        <button @click="openWithdrawModal" class="flex items-center justify-center gap-2 py-3.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-100 transition">
                            <i class="ri-bank-card-fill"></i> æç°
                        </button>
                    </div>
                </div>
            </div>

<div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden mb-8">
                <div @click="openInviteModal" class="flex items-center justify-between p-5 border-b border-slate-50 bg-gradient-to-r from-violet-50 to-purple-50 cursor-pointer hover:brightness-95 transition relative overflow-hidden group">
                    <div class="flex items-center gap-3 relative z-10">
                        <div class="w-8 h-8 rounded-full bg-violet-500 text-white flex items-center justify-center shadow-lg shadow-violet-500/30">
                            <i class="ri-gift-2-fill"></i>
                        </div>
                        <div>
                            <span class="text-violet-900 font-bold text-base">é‚€è¯·æœ‰ç¤¼</span>
                            <span class="ml-2 text-[10px] text-white bg-violet-500 px-1.5 py-0.5 rounded">èµš 5%</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 relative z-10">
                        <span class="text-xs text-violet-600 font-medium">æŸ¥çœ‹è¯¦æƒ…</span>
                        <i class="ri-arrow-right-s-line text-violet-400"></i>
                    </div>
                    <div class="absolute -right-2 -bottom-4 text-violet-100 text-6xl opacity-50 group-hover:scale-110 transition duration-500 rotate-12">
                        <i class="ri-money-cny-circle-fill"></i>
                    </div>
                </div>

                <div @click="checkLoginAndGo('orders_page')" class="flex items-center justify-between p-5 border-b border-slate-50 hover:bg-slate-50 cursor-pointer active:bg-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="ri-file-list-3-line"></i></div>
                        <span class="text-slate-700 font-medium">æˆ‘çš„è®¢å•</span>
                    </div>
                    <i class="ri-arrow-right-s-line text-slate-300"></i>
                </div>

                <div @click="openRecordModal('recharge')" class="flex items-center justify-between p-5 border-b border-slate-50 hover:bg-slate-50 cursor-pointer active:bg-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center"><i class="ri-add-circle-line"></i></div>
                        <span class="text-slate-700 font-medium">å……å€¼è®°å½•</span>
                    </div>
                    <i class="ri-arrow-right-s-line text-slate-300"></i>
                </div>

                <div @click="openRecordModal('withdraw')" class="flex items-center justify-between p-5 border-b border-slate-50 hover:bg-slate-50 cursor-pointer active:bg-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center"><i class="ri-subtract-line"></i></div>
                        <span class="text-slate-700 font-medium">æç°è®°å½•</span>
                    </div>
                    <i class="ri-arrow-right-s-line text-slate-300"></i>
                </div>

                <div @click="profileTab = 'security'; view = 'security_page'" class="flex items-center justify-between p-5 border-b border-slate-50 hover:bg-slate-50 cursor-pointer active:bg-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center"><i class="ri-shield-key-line"></i></div>
                        <span class="text-slate-700 font-medium">è´¦å·å®‰å…¨</span>
                    </div>
                    <i class="ri-arrow-right-s-line text-slate-300"></i>
                </div>

                <div @click="showAddToHomeGuide('user')" class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer active:bg-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="ri-download-cloud-2-line"></i></div>
                        <div class="flex flex-col">
                            <span class="text-slate-700 font-medium">ä¸‹è½½APP</span>
                            <span class="text-[10px] text-slate-400">å®‰è£…åˆ°æ¡Œé¢ä½“éªŒæ›´å¥½</span>
                        </div>
                    </div>
                    <i class="ri-arrow-right-s-line text-slate-300"></i>
                </div>
            </div>

            <button @click="logout" class="w-full py-4 text-slate-400 font-medium hover:text-red-500 transition mb-10">é€€å‡ºç™»å½•</button>
        </div>

<div v-if="view === 'orders_page'" class="animate-fade-in max-w-2xl mx-auto">
            <div class="flex items-center gap-2 mb-6 sticky top-20 z-10 bg-slate-50/90 backdrop-blur py-2">
                <button @click="view='profile'" class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 shadow-sm"><i class="ri-arrow-left-line"></i></button>
                <h2 class="text-xl font-bold text-slate-800">æˆ‘çš„è®¢å•</h2>
            </div>
            
            <div v-if="myOrders.length === 0" class="text-center py-20">
                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ri-file-list-3-line text-4xl text-slate-300"></i>
                </div>
                <span class="text-slate-400 font-medium">æš‚æ— è®¢å•è®°å½•</span>
            </div>

            <div v-else class="space-y-4 pb-20">
                <div v-for="order in myOrders.filter(o => o.product_name !== 'ä½™é¢å……å€¼')" :key="order.order_id" class="bg-white border border-slate-100 rounded-2xl p-5 shadow-sm hover:shadow-md transition duration-300 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 px-3 py-1 text-xs font-bold rounded-bl-xl" 
     :class="{
         'bg-slate-200 text-slate-500': isOrderExpired(order) && order.status === 'å¾…æ”¯ä»˜',
         'bg-brand-50 text-brand-600': !isOrderExpired(order) && order.status === 'å¾…æ”¯ä»˜',
         'bg-emerald-50 text-emerald-600': order.status === 'å·²æ”¯ä»˜' || order.status === 'å·²å‘è´§',
         'bg-slate-100 text-slate-500': order.status === 'å·²å–æ¶ˆ'
     }">
    {{ (isOrderExpired(order) && order.status === 'å¾…æ”¯ä»˜') ? 'å·²è¿‡æœŸ' : order.status }}
</div>

                    <div class="flex items-center gap-2 mb-4 pr-16">
                        <span class="bg-slate-100 text-slate-500 text-[10px] px-1.5 py-0.5 rounded font-mono">è®¢å•å·</span>
                        <span class="text-xs text-slate-500 font-fix select-all cursor-pointer hover:text-brand-500" @click="navigator.clipboard.writeText(order.order_id)" title="ç‚¹å‡»å¤åˆ¶">
                            {{ order.order_id }} <i class="ri-file-copy-line ml-0.5"></i>
                        </span>
                    </div>

                    <div class="flex gap-4 mb-4">
                        <div class="w-16 h-16 bg-slate-50 rounded-lg overflow-hidden flex-shrink-0 border border-slate-100">
                         <img v-if="getImgList(order).length > 0" :src="getImgList(order)[0]" class="w-full h-full object-cover">
                         <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="ri-shopping-bag-3-line text-2xl"></i></div>
                    </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-slate-800 text-base mb-1 truncate">{{ order.product_name }}</h3>
                            <div class="flex items-center gap-2 text-xs text-slate-400">
                                <span class="bg-slate-50 px-2 py-0.5 rounded border border-slate-100">æ•°é‡ x{{ order.quantity || 1 }}</span>
                                <span>{{ formatDate(order.created_at) }}</span>
                            </div>
                        </div>
                    </div>

                   <div class="pt-4 border-t border-slate-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-xs text-slate-400 block">å®ä»˜é‡‘é¢</span>
                                <span class="text-lg font-bold text-slate-800 font-mono">{{ parseFloat(order.usdt_amount).toFixed(2) }} <span class="text-xs font-normal text-slate-500">USDT</span></span>
                            </div>
                            
                            <div class="flex flex-wrap justify-end gap-2 mt-2">
                                <button v-if="order.status === 'å¾…æ”¯ä»˜' && !isOrderExpired(order)" @click.stop="cancelOrder(order.order_id)" class="px-4 py-2 text-slate-500 text-xs font-bold hover:bg-slate-100 rounded-lg transition border border-slate-200">
                                    å–æ¶ˆè®¢å•
                                </button>
                                
                                <button v-if="order.status === 'å¾…æ”¯ä»˜' && !isOrderExpired(order)" @click.stop="showPaymentInfo(order)" class="btn-gradient px-4 py-2 text-white text-xs font-bold rounded-lg shadow-md hover:-translate-y-0.5 transition flex items-center gap-1">
                                    å»æ”¯ä»˜/ä¸Šä¼ å‡­è¯ <i class="ri-secure-payment-line"></i>
                                </button>
                                
                                <button v-if="order.status === 'å¾…æ ¸å®'" class="px-3 py-2 text-brand-600 bg-brand-50 text-xs font-bold rounded-lg cursor-default border border-brand-100">
                                    <i class="ri-time-line"></i> å‡­è¯æ ¸å®ä¸­
                                </button>

                                <button v-if="order.status === 'å·²æ”¯ä»˜' || order.status === 'å·²å‘è´§'" @click.stop="toggleChat" class="px-4 py-2 text-emerald-600 bg-emerald-50 text-xs font-bold rounded-lg hover:bg-emerald-100 transition border border-emerald-100">
                                    <i class="ri-customer-service-2-line"></i> è”ç³»å”®å
                                </button>
                            </div>
                        </div>

                        <div v-if="order.status === 'å·²å–æ¶ˆ'" class="mt-3 bg-red-50 border border-red-100 rounded-lg p-3 text-xs text-red-600 leading-relaxed flex items-start gap-2">
                            <i class="ri-error-warning-fill text-base mt-0.5"></i>
                            <div>
                                <p class="font-bold">è¯¥ç¬”è®¢å•å·²è¢«å®¢æœå–æ¶ˆ</p>
                                <p>å¦‚æœ‰ç–‘é—®è¯·è”ç³»å®¢æœ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="view === 'security_page'" class="animate-fade-in max-w-lg mx-auto">
             <div class="flex items-center gap-2 mb-6">
                <button @click="view='profile'" class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500"><i class="ri-arrow-left-line"></i></button>
                <h2 class="text-xl font-bold text-slate-800">ä¿®æ”¹å¯†ç </h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                 <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">æ—§å¯†ç </label>
                        <input v-model="securityForm.oldPassword" type="password" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">æ–°å¯†ç </label>
                        <input v-model="securityForm.newPassword" type="password" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">ç¡®è®¤æ–°å¯†ç </label>
                        <input v-model="securityForm.confirmPassword" type="password" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3">
                    </div>
                    <button @click="changePassword" class="w-full btn-gradient text-white font-bold py-3 rounded-lg shadow-lg mt-2">ç¡®è®¤ä¿®æ”¹</button>
                 </div>
            </div>
        </div>

        <!-- è´­ç‰©è½¦é¡µé¢ -->
        <div v-if="view === 'cart'" class="animate-fade-in">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-slate-800 tracking-tight flex items-center gap-2">
                    <i class="ri-shopping-cart-2-line text-brand-500"></i> è´­ç‰©è½¦
                </h2>
                <button @click="clearCart" class="text-sm text-slate-500 hover:text-red-500 transition">
                    <i class="ri-delete-bin-line"></i> æ¸…ç©ºè´­ç‰©è½¦
                </button>
            </div>

            <div v-if="cartItems.length === 0" class="text-center py-20 bg-white rounded-2xl border border-dashed border-slate-200">
                <i class="ri-shopping-cart-line text-6xl text-slate-300 mb-4 block"></i>
                <h3 class="text-slate-600 font-medium mb-2">è´­ç‰©è½¦æ˜¯ç©ºçš„</h3>
                <p class="text-slate-400 text-sm mb-6">å¿«å»æŒ‘é€‰å–œæ¬¢çš„å•†å“å§</p>
                <button @click="setView('home')" class="btn-gradient text-white font-bold py-2.5 px-6 rounded-lg">
                    å»é€›é€›
                </button>
            </div>

            <div v-else class="space-y-4">
                <div v-for="item in cartItems" :key="item.id" class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center gap-4">
                        <div class="w-20 h-20 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0">
                            <img v-if="getImgList(item).length > 0" :src="getImgList(item)[0]" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-slate-300">
                                <i class="ri-image-2-line text-2xl"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-800 mb-1">{{ item.name }}</h3>
                            <p class="text-sm text-slate-500 mb-2">{{ item.description.substring(0, 50) }}...</p>
                            <div class="flex items-center justify-between">
                                <div class="text-lg font-bold text-brand-600">{{ item.price }} USDT</div>
                                <div class="flex items-center gap-2">
                                    <button @click="updateCartQuantity(item, -1)" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 transition">
                                        <i class="ri-subtract-line"></i>
                                    </button>
                                    <span class="w-10 text-center font-bold">{{ item.quantity || 1 }}</span>
                                    <button @click="updateCartQuantity(item, 1)" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 transition">
                                        <i class="ri-add-line"></i>
                                    </button>
                                    <button @click="removeFromCart(item)" class="ml-4 text-red-500 hover:text-red-700">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-bold text-slate-800">åˆè®¡</span>
                        <div class="text-2xl font-bold text-brand-600">{{ cartTotal.toFixed(2) }} USDT</div>
                    </div>
                    <button @click="checkoutCart" class="w-full btn-gradient text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-500/20 hover:-translate-y-1 transition">
                        å»ç»“ç®— ({{ cartItems.length }}ä»¶å•†å“)
                    </button>
                </div>
    </div>
</div>
<div id="mobile-bottom-nav" class="md:hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[90%] max-w-[380px] h-[68px] bg-white/75 backdrop-blur-2xl border border-white/40 rounded-full shadow-[0_8px_32px_rgba(0,0,0,0.12)] z-50 flex justify-around items-center px-2">
    
    <div @click="setView('home')" class="flex flex-col items-center justify-center w-16 h-full cursor-pointer transition-transform duration-200 active:scale-90" :class="view==='home' ? 'text-[#007aff]' : 'text-[#8e8e93]'">
        <i class="text-[24px] mb-0.5" :class="view==='home' ? 'ri-home-4-fill' : 'ri-home-4-line'"></i>
        <span class="text-[10px] font-medium tracking-tight">é¦–é¡µ</span>
    </div>

    <div @click="checkLoginAndGo('orders_page')" class="flex flex-col items-center justify-center w-16 h-full cursor-pointer transition-transform duration-200 active:scale-90" :class="view==='orders_page' ? 'text-[#007aff]' : 'text-[#8e8e93]'">
        <i class="text-[24px] mb-0.5" :class="view==='orders_page' ? 'ri-file-list-3-fill' : 'ri-file-list-3-line'"></i>
        <span class="text-[10px] font-medium tracking-tight">è®¢å•</span>
    </div>

    <div @click="setView('hiring')" class="flex flex-col items-center justify-center w-16 h-full cursor-pointer transition-transform duration-200 active:scale-90" :class="view==='hiring' ? 'text-[#007aff]' : 'text-[#8e8e93]'">
        <i class="text-[24px] mb-0.5" :class="view==='hiring' ? 'ri-briefcase-fill' : 'ri-briefcase-line'"></i>
        <span class="text-[10px] font-medium tracking-tight">æ‹›è˜</span>
    </div>

    <div @click="checkLoginAndGo('profile')" class="flex flex-col items-center justify-center w-16 h-full cursor-pointer transition-transform duration-200 active:scale-90" :class="view==='profile' && profileTab!=='orders' ? 'text-[#007aff]' : 'text-[#8e8e93]'">
        <i class="text-[24px] mb-0.5" :class="view==='profile' && profileTab!=='orders' ? 'ri-user-3-fill' : 'ri-user-3-line'"></i>
        <span class="text-[10px] font-medium tracking-tight">æˆ‘çš„</span>
    </div>

</div>

    </main> 

    <!-- å®¢æœæ‚¬æµ®çª— -->
    <div class="chat-widget">
        <div v-if="chatOpen" class="chat-overlay" @click="toggleChat"></div>
        
        <div v-if="chatOpen" class="chat-window flex flex-col animate-fade-in-up">
            <div class="bg-brand-500 p-4 text-white flex justify-between items-center flex-shrink-0">
                <div>
                    <span class="font-bold flex items-center gap-2"><i class="ri-customer-service-2-line"></i> åœ¨çº¿å®¢æœ</span>
                    <div class="text-[10px] opacity-80 flex items-center gap-1 mt-1">
                        <span class="w-2 h-2 rounded-full" :class="isServiceOnline ? 'bg-green-400' : 'bg-gray-400'"></span>
                        {{ isServiceOnline ? 'å®¢æœå¿™ç¢Œ (12:00-24:00)' : 'å®¢æœä¼‘æ¯ä¸­ (12:00-24:00)' }}
                    </div>
                </div>
                <button @click="toggleChat" class="hover:bg-brand-600 rounded-full w-6 h-6 flex items-center justify-center"><i class="ri-close-line"></i></button>
            </div>
            <div id="chat-msgs" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col gap-2">
                <div v-for="(msg, idx) in chatMessages" :key="idx" :class="['chat-msg', msg.sender === 'user' ? 'user' : 'admin']">
                    <template v-if="msg.msg_type === 'image'">
                        <img :src="msg.content" class="rounded-lg max-w-full cursor-pointer" @click="window.open(msg.content, '_blank')" style="max-height: 150px;">
                    </template>
                    <template v-else>
                        {{ msg.content }}
                    </template>
                </div>
                <div v-if="chatMessages.length === 0" class="text-center text-xs text-slate-400 mt-10">
                    ğŸ‘‹ ä½ å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ
                </div>
            </div>
           <div class="p-3 bg-white border-t border-slate-100 flex gap-2 flex-shrink-0 items-center">
                <button @click="$refs.chatImgInput.click()" class="text-slate-400 hover:text-brand-500 p-1">
                    <i class="ri-image-add-line text-xl"></i>
                </button>
                <input type="file" ref="chatImgInput" class="hidden" accept="image/*" @change="sendChatImage">

                <input v-model="chatInput" @keypress.enter="sendMessage" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-brand-500">
                <button @click="sendMessage" class="bg-brand-500 text-white rounded-lg px-3 py-2 hover:bg-brand-600"><i class="ri-send-plane-fill"></i></button>
            </div>
        </div>
        <button @click="toggleChat" class="w-14 h-14 bg-gradient-to-r from-brand-500 to-brand-purple rounded-full shadow-lg text-white flex items-center justify-center text-2xl hover:scale-105 transition relative">
            <i class="ri-chat-smile-3-line"></i>
            <span v-if="unreadMessages > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">{{ unreadMessages }}</span>
        </button>
    </div>

    <footer class="bg-white border-t border-slate-200 py-10 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="flex items-center justify-center gap-2 mb-4">
                <div class="w-6 h-6 rounded bg-slate-200 flex items-center justify-center text-slate-500">
                    <i class="ri-command-line text-xs"></i>
                </div>
                <span class="font-bold text-slate-1111">å°æš—ç½‘ XAW888.com</span>
            </div>
            <p class="text-xs text-slate-400">Â© {{ new Date().getFullYear() }} Dark Web  All Rights Reserved. </p>
        </div>
    </footer>

    <!-- å•†å“è¯¦æƒ…æ¨¡æ€æ¡† -->
    <transition name="modal">
        <div v-if="productDetailModal.open" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" @click.self="productDetailModal.open = false">
            <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col md:flex-row modal-content relative">
                <button @click="productDetailModal.open = false" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-white/80 flex items-center justify-center text-slate-500 hover:text-slate-800 hover:bg-white transition shadow-sm">
                    <i class="ri-close-line text-xl"></i>
                </button>

                <div class="w-full md:w-1/2 bg-slate-100 relative h-64 md:h-auto group select-none">
                    <img v-if="currentProdImgs.length > 0" :src="currentProdImgs[currentImgIndex]" class="w-full h-full object-contain cursor-pointer" @click="nextImage">
                    <div v-else class="w-full h-full flex flex-col items-center justify-center bg-slate-50 text-slate-300">
    <i class="ri-spy-fill text-6xl opacity-20 mb-4"></i>
    <span class="text-sm font-bold opacity-40 tracking-widest">æš‚æ— å•†å“å›¾ç‰‡</span>
</div>
                    
                    <div v-if="currentProdImgs.length > 1">
                        <div class="carousel-btn left" @click.stop="prevImage"><i class="ri-arrow-left-s-line"></i></div>
                        <div class="carousel-btn right" @click.stop="nextImage"><i class="ri-arrow-right-s-line"></i></div>
                        <div class="absolute bottom-4 left-0 w-full flex justify-center gap-2">
                            <div v-for="(img, idx) in currentProdImgs" :key="idx" :class="['w-2 h-2 rounded-full transition', idx===currentImgIndex ? 'bg-brand-500' : 'bg-slate-300']"></div>
                        </div>
                    </div>
                </div>

                <div class="w-full md:w-1/2 p-8 flex flex-col overflow-y-auto">
                    <div class="mb-1">
                        <span class="bg-brand-50 text-brand-600 px-3 py-1 rounded-full text-xs font-bold">{{ productDetailModal.prod.category }}</span>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">{{ productDetailModal.prod.name }}</h2>
                    
                    <div class="bg-slate-50 p-4 rounded-xl mb-6">
                        <div class="text-3xl font-bold text-brand-600 font-mono">
                            {{ parseFloat(productDetailModal.prod.price || 0) }} 
                            <span class="text-sm text-slate-500 font-sans font-normal">USDT</span>
                        </div>
                        <div class="text-sm text-slate-400 mt-1">â‰ˆ Â¥{{ (productDetailModal.prod.price * settings.rate).toFixed(2) }} (æ±‡ç‡: {{settings.rate}})</div>
                    </div>
                  

                    <div class="prose prose-sm text-slate-600 mb-8 flex-grow">
                        <h4 class="text-sm font-bold text-slate-800 mb-2">å•†å“è¯¦æƒ…</h4>
                        <p class="whitespace-pre-wrap leading-relaxed">{{ productDetailModal.prod.description }}</p>
                    </div>

                    <div class="mt-auto pt-6 border-t border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm text-slate-500">åº“å­˜çŠ¶æ€</span>
                            <span :class="productDetailModal.prod.stock > 0 ? 'text-emerald-600' : 'text-red-600'" class="font-bold text-sm">
                                {{ productDetailModal.prod.stock > 0 ? `å‰©ä½™ ${productDetailModal.prod.stock} ä»¶` : 'æš‚æ—¶ç¼ºè´§' }}
                            </span>
                        </div>
                        <div class="flex flex-col gap-3">
    <template v-if="productDetailModal.prod.stock > 0">
        <button @click="openBuyModal(productDetailModal.prod)" class="w-full btn-gradient text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-500/20 hover:-translate-y-0.5 transition flex items-center justify-center gap-2 text-base">
            <i class="ri-flash-light-fill"></i> ç«‹å³è´­ä¹°
        </button>
        <button @click="addToCart(productDetailModal.prod)" class="w-full bg-white border-2 border-slate-100 text-slate-600 font-bold py-3.5 rounded-xl hover:bg-slate-50 hover:border-slate-200 hover:text-brand-600 transition flex items-center justify-center gap-2">
            <i class="ri-shopping-cart-2-line"></i> åŠ å…¥è´­ç‰©è½¦
        </button>
    </template>
    <template v-else>
        <div class="bg-orange-50 p-3 rounded-xl border border-orange-100">
            <p class="text-xs text-orange-600 font-bold mb-2">ğŸ“¢ å•†å“ç¼ºè´§ï¼Œç™»è®°åå®¢æœè¡¥è´§ä¼šé€šçŸ¥æ‚¨</p>
            <div class="flex gap-2">
                <input v-model="restockContact" placeholder="è¾“å…¥æ‚¨çš„ é‚®ç®± æˆ– Telegram" class="flex-1 text-sm p-2 border border-orange-200 rounded-lg outline-none focus:border-orange-400">
                <button @click="submitRestock(productDetailModal.prod)" class="bg-orange-500 text-white text-sm px-4 rounded-lg font-bold hover:bg-orange-600">æäº¤</button>
            </div>
        </div>
    </template>
</div>
                    </div>
                </div>
            </div>
        </div>
    </transition>
 <transition name="modal">
        <div v-if="inviteModal.open" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" @click.self="inviteModal.open = false">
            <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl modal-content relative">
                <div class="h-32 bg-gradient-to-br from-violet-500 to-fuchsia-600 relative flex flex-col items-center justify-center text-white p-6">
                    <button @click="inviteModal.open = false" class="absolute top-4 right-4 text-white/80 hover:text-white bg-black/10 rounded-full w-8 h-8 flex items-center justify-center backdrop-blur-sm transition">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                    <i class="ri-gift-2-fill text-5xl mb-2 drop-shadow-md"></i>
                    <h3 class="text-xl font-bold tracking-wide drop-shadow-md">é‚€è¯·å¥½å‹ èµšå–ä½£é‡‘</h3>
                </div>

                <div class="p-6 relative">
                    <div class="bg-white border border-slate-100 rounded-xl shadow-lg -mt-12 p-5 text-center relative z-10">
                        <p class="text-xs text-slate-400 mb-2 uppercase tracking-wider">æ‚¨çš„ä¸“å±é‚€è¯·ç </p>
                        <div class="flex items-center justify-center gap-3 mb-4">
                            <span class="text-3xl font-mono font-bold text-slate-800 tracking-widest border-b-2 border-violet-100 pb-1">
                                {{ user.inviteCode || 'è¯·å…ˆç™»å½•' }}
                            </span>
                        </div>
                        <button @click="navigator.clipboard.writeText(user.inviteCode); Swal.fire({icon:'success', title:'å¤åˆ¶æˆåŠŸ', timer:1000, showConfirmButton:false})" class="w-full btn-gradient text-white font-bold py-2.5 rounded-lg shadow-violet-500/30 shadow-lg hover:-translate-y-0.5 transition flex items-center justify-center gap-2 text-sm">
                            <i class="ri-file-copy-line"></i> å¤åˆ¶é‚€è¯·ç 
                        </button>
                    </div>

                    <div class="mt-6 space-y-4">
                        <div class="flex gap-4 items-start">
                            <div class="w-10 h-10 rounded-full bg-violet-50 text-violet-500 flex items-center justify-center shrink-0">
                                <i class="ri-user-add-line text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">1. é‚€è¯·å¥½å‹æ³¨å†Œ</h4>
                                <p class="text-xs text-slate-500 mt-1 leading-relaxed">
                                    è®©å¥½å‹åœ¨æ³¨å†Œæ—¶è¾“å…¥æ‚¨çš„é‚€è¯·ç ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç»‘å®šä½ ä»¬çš„é‚€è¯·å…³ç³»ã€‚
                                </p>
                            </div>
                        </div>
<div class="flex gap-4 items-start">
                            <div class="w-10 h-10 rounded-full bg-fuchsia-50 text-fuchsia-500 flex items-center justify-center shrink-0">
                                <i class="ri-money-dollar-circle-line text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">2. è·å¾— 5% ä½£é‡‘</h4>
                                <p class="text-xs text-slate-500 mt-1 leading-relaxed">
                                    å½“æ‚¨çš„å¥½å‹è¿›è¡Œå……å€¼æˆ–æ¶ˆè´¹æ—¶ï¼Œæ‚¨å°†ç›´æ¥è·å¾— 5% çš„ç°é‡‘è¿”åˆ©åˆ°ä½™é¢ã€‚å¯æç°å¯è´­ç‰©
                                </p>
                            </div>
                        </div>
                    </div>

                    <div v-if="user.id" class="mt-6 border-t border-slate-100 pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-slate-800">æˆ‘çš„å›¢é˜Ÿæ”¶ç›Š</h4>
                            <span class="text-xs text-fuchsia-600 font-bold bg-fuchsia-50 px-2 py-1 rounded">æ€»èµš: {{ inviteModal.totalEarned.toFixed(2) }} USDT</span>
                        </div>
                        <div class="max-h-40 overflow-y-auto space-y-2 bg-slate-50 p-2 rounded-lg">
                            <div v-if="inviteModal.list.length === 0" class="text-center text-xs text-slate-400 py-2">æš‚æ— é‚€è¯·è®°å½•</div>
                            <div v-for="team in inviteModal.list" :key="team.id" class="flex justify-between text-xs items-center bg-white p-2 rounded border border-slate-100">
                                <div>
                                    <div class="font-bold text-slate-700">{{ team.contact }}</div>
                                    <div class="text-slate-400 scale-90 origin-left">{{ new Date(team.created_at).toLocaleDateString() }}</div>
                                </div>
                                <div class="text-emerald-600 font-mono">+{{ parseFloat(team.earned).toFixed(2) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- è®¤è¯æ¨¡æ€æ¡† -->
<transition name="modal">
        <div v-if="authModal.open" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4" @click.self="authModal.open = false">
            <div class="bg-white rounded-2xl w-full max-w-[400px] p-5 shadow-2xl modal-content relative max-h-[85vh] overflow-y-auto scrollbar-hide">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800">{{ authModal.mode === 'login' ? 'ç”¨æˆ·ç™»å½•' : 'ç”¨æˆ·æ³¨å†Œ' }}</h3>
                    <button @click="authModal.open = false" class="text-slate-400 hover:text-slate-600">
                        <i class="ri-close-line text-2xl"></i>
                    </button>
                </div>

                <form @submit.prevent="handleAuth" class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1.5">è´¦å·</label>
                        <input v-model="authForm.contact" required type="text" placeholder="è¯·è¾“å…¥é‚®ç®±æˆ–Telegram" class="w-full bg-white border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-50 focus:outline-none transition text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1.5">å¯†ç </label>
                        <input v-model="authForm.password" required type="password" placeholder="è¯·è¾“å…¥å¯†ç  (è‡³å°‘6ä½)" class="w-full bg-white border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-50 focus:outline-none transition text-sm">
                    </div>
                    
                   <div v-if="authModal.mode === 'register'">
                        <label class="block text-sm font-bold text-slate-700 mb-1.5">ç¡®è®¤å¯†ç </label>
                        <input v-model="authForm.confirmPassword" required type="password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " class="w-full bg-white border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-50 focus:outline-none transition text-sm">
                    </div>

                    <div v-if="authModal.mode === 'register'">
                        <label class="block text-sm font-bold text-slate-700 mb-1.5">é‚€è¯·ç  (é€‰å¡«)</label>
                        <input v-model="authForm.inviteCode" type="text" placeholder="è¯·è¾“å…¥é‚€è¯·ç " class="w-full bg-white border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-50 focus:outline-none transition text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1.5">äººæœºéªŒè¯</label>
                        <div class="flex gap-3 mb-3">
                            <div class="flex-1 captcha-display h-11 rounded-lg border border-brand-100 flex items-center justify-center text-xl tracking-[0.5em] shadow-inner">
                                {{ captcha.display }}
                            </div>
                            <button type="button" @click="genCaptcha" class="w-11 h-11 bg-brand-500 rounded-lg text-white hover:bg-brand-600 transition flex items-center justify-center shadow-md shadow-brand-500/20">
                                <i class="ri-refresh-line text-lg"></i>
                            </button>
                        </div>
                        <input v-model="authForm.captchaInput" required type="text" placeholder="è¯·è¾“å…¥ä¸Šæ–¹éªŒè¯ç " class="w-full bg-white border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-50 focus:outline-none transition text-sm">
                    </div>
                    <button type="submit" :disabled="authSubmitting" class="w-full btn-gradient text-white font-bold py-3 rounded-lg shadow-lg shadow-brand-500/25 disabled:opacity-50 flex justify-center text-sm tracking-wide mt-2">
                        <span v-if="authSubmitting" class="animate-spin mr-2"><i class="ri-loader-4-line"></i></span>
                        {{ authModal.mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ' }}
                    </button>
                </form>
                
                <div class="mt-6 text-center text-sm">
                    <span v-if="authModal.mode === 'login'" class="text-slate-500">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a @click="toggleAuthMode" class="text-brand-600 font-bold cursor-pointer hover:underline">ç«‹å³æ³¨å†Œ</a></span>
                    <span v-else class="text-slate-500">å·²æœ‰è´¦å·ï¼Ÿ <a @click="toggleAuthMode" class="text-brand-600 font-bold cursor-pointer hover:underline">ç«‹å³ç™»å½•</a></span>
                </div>
            </div>
        </div>
    </transition>

    <!-- è´­ä¹°æ¨¡æ€æ¡† -->
    <transition name="modal">
        <div v-if="buyModal.open" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 sm:p-4" @click.self="buyModal.open = false">
            <div class="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-lg max-h-[85vh] flex flex-col modal-content relative shadow-2xl">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">ç¡®è®¤è®¢å•</h3>
                        <p class="text-xs text-slate-500 mt-0.5">å•†å“: {{ buyModal.prod.name }}</p>
                    </div>
                    <button @click="buyModal.open = false" class="text-slate-400 hover:text-slate-600"><i class="ri-close-line text-2xl"></i></button>
                </div>
                
                <div class="p-6 space-y-5 overflow-y-auto">
                    <div>
                        <label class="block text-sm font-bold text-brand-600 mb-2">
                            <i class="ri-mail-send-line"></i> è”ç³»æ–¹å¼ (å¿…å¡«)
                        </label>
                        <input v-model="buyForm.contactInfo" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±æˆ– Telegram ç”¨æˆ·å" class="w-full bg-white border border-brand-200 rounded-lg p-3 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-50 focus:outline-none transition">
                        <p class="text-xs text-slate-400 mt-1">ç”¨äºæ¥æ”¶å‘è´§é€šçŸ¥æˆ–å”®åè”ç³»</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-3">é€‰æ‹©æ”¯ä»˜æ–¹å¼</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div @click="buyForm.method = 'USDT'" :class="buyForm.method === 'USDT' ? 'border-brand-500 bg-brand-50 text-brand-700 ring-1 ring-brand-500' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'" class="border rounded-xl p-4 cursor-pointer transition flex flex-col items-center gap-2 text-center">
                                <i class="ri-money-dollar-circle-line text-2xl" :class="buyForm.method==='USDT'?'text-brand-600':'text-slate-400'"></i>
                                <div>
                                    <div class="text-sm font-bold">USDT (TRC20)</div>
                                    <div class="text-[10px] opacity-70">åˆ°è´¦å¿« / æ¨è</div>
                                </div>
                            </div>
                            <div @click="buyForm.method = 'WeChat'" :class="buyForm.method === 'WeChat' ? 'border-brand-500 bg-brand-50 text-brand-700 ring-1 ring-brand-500' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'" class="border rounded-xl p-4 cursor-pointer transition flex flex-col items-center gap-2 text-center">
                                <i class="ri-wechat-pay-line text-2xl" :class="buyForm.method==='WeChat'?'text-brand-600':'text-slate-400'"></i>
                                <div>
                                    <div class="text-sm font-bold">å¾®ä¿¡æ”¯ä»˜</div>
                                    <div class="text-[10px] opacity-70">äººå·¥æ ¸å®åˆ°è´¦</div>
                                </div>
                            </div>
                            <div @click="buyForm.method = 'Alipay'" :class="buyForm.method === 'Alipay' ? 'border-brand-500 bg-brand-50 text-brand-700 ring-1 ring-brand-500' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'" class="border rounded-xl p-4 cursor-pointer transition flex flex-col items-center gap-2 text-center">
                                <i class="ri-alipay-line text-2xl" :class="buyForm.method==='Alipay'?'text-brand-600':'text-slate-400'"></i>
                                <div>
                                    <div class="text-sm font-bold">æ”¯ä»˜å®</div>
                                    <div class="text-[10px] opacity-70">äººå·¥æ ¸å®åˆ°è´¦</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä½™é¢æ”¯ä»˜é€‰é¡¹ -->
                    <div v-if="user.balance > 0" class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-100 p-4 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-bold text-emerald-800 flex items-center gap-1"><i class="ri-wallet-3-fill"></i> è´¦æˆ·ä½™é¢</div>
                            <div class="font-mono text-emerald-600">{{ (user.balance || 0).toFixed(2) }} USDT</div>
                        </div>
                        
                        <label class="flex items-center justify-between cursor-pointer bg-white p-3 rounded-lg border border-emerald-200 shadow-sm hover:border-emerald-400 transition">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" v-model="buyForm.useBalance" @change="buyForm.balanceAmount = buyForm.useBalance ? Math.min(user.balance, buyModal.prod.price) : 0" class="w-5 h-5 text-brand-600 rounded focus:ring-brand-500">
                                <span class="text-sm font-bold text-slate-700">å¼€å¯ç»„åˆæ”¯ä»˜ (æŠµæ‰£ä½™é¢)</span>
                            </div>
                            <div v-if="buyForm.useBalance" class="text-sm font-bold text-red-500">
                                - {{ Math.min(user.balance, buyModal.prod.price).toFixed(2) }}
                            </div>
                        </label>
                        <p v-if="buyForm.useBalance" class="text-[10px] text-emerald-600 mt-2 text-right">
                            * ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æœ€å¤§å¯æŠµæ‰£é‡‘é¢
                        </p>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-slate-500">å•†å“å•ä»·:</span>
                            <span class="text-slate-800 font-mono">{{ buyModal.prod.price }} USDT</span>
                        </div>
                        <div v-if="buyForm.method !== 'USDT'" class="flex justify-between text-sm mb-2">
                            <span class="text-slate-500">å½“å‰æ±‡ç‡:</span>
                            <span class="text-slate-800 font-mono">{{ settings.rate }}</span>
                        </div>
                        <div v-if="buyForm.method !== 'USDT' && settings.feeRate > 0" class="flex justify-between text-sm mb-2">
                            <span class="text-slate-500">æ‰‹ç»­è´¹ ({{ settings.feeRate }}%):</span>
                            <span class="text-red-500 font-mono">+ Â¥{{ ((buyModal.prod.price * settings.rate) * (settings.feeRate/100)).toFixed(2) }}</span>
                        </div>
                        <div v-if="buyForm.useBalance && buyForm.balanceAmount > 0" class="flex justify-between text-sm mb-2">
                            <span class="text-slate-500">ä½™é¢æŠµæ‰£:</span>
                            <span class="text-emerald-500 font-mono">- {{ buyForm.balanceAmount }} USDT</span>
                        </div>
                        <div class="border-t border-slate-200 my-3"></div>
                        <div class="flex justify-between items-end">
                            <span class="text-slate-800 font-bold text-sm">åº”ä»˜é‡‘é¢:</span>
                            <span class="text-2xl font-bold text-brand-600 font-mono">
                                {{ calculateFinalAmount(buyModal.prod.price) }}
                            </span>
                        </div>
                    </div>

                    <div v-if="buyModal.prod.type === 'physical'" class="animate-fade-in-up">
                        <label class="block text-xs text-orange-500 mb-2 font-bold flex items-center gap-1">
                            <i class="ri-truck-line"></i> æ”¶è´§ä¿¡æ¯ (å®ç‰©å•†å“å¿…å¡«)
                        </label>
                        <div class="space-y-2">
                            <div class="flex gap-2">
                                <input v-model="buyForm.shipName" placeholder="æ”¶ä»¶äººå§“å" class="flex-1 bg-white border border-slate-200 rounded-lg p-2.5 text-sm focus:border-brand-500 focus:outline-none">
                                <input v-model="buyForm.shipTel" placeholder="è”ç³»ç”µè¯" class="flex-1 bg-white border border-slate-200 rounded-lg p-2.5 text-sm focus:border-brand-500 focus:outline-none">
                            </div>
                            <textarea v-model="buyForm.shipAddr" placeholder="è¯¦ç»†æ”¶è´§åœ°å€ (çœ/å¸‚/åŒº/è¡—é“/é—¨ç‰Œ)" class="w-full bg-white border border-slate-200 rounded-lg p-2.5 text-sm focus:border-brand-500 focus:outline-none h-20 resize-none"></textarea>
                        </div>
                    </div>

                    <button @click="submitOrder" :disabled="orderSubmitting" class="w-full btn-gradient text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-500/20 disabled:opacity-50 flex justify-center text-sm tracking-wide shrink-0 mb-safe">
                        <span v-if="orderSubmitting" class="animate-spin mr-2"><i class="ri-loader-4-line"></i></span>
                        æäº¤è®¢å•
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- å……å€¼æ¨¡æ€æ¡† -->
    <transition name="modal">
        <div v-if="rechargeModal.open" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" @click.self="rechargeModal.open = false">
            <div class="bg-white rounded-2xl w-full max-w-lg p-6 modal-content relative shadow-2xl">
                <button @click="rechargeModal.open = false" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="ri-close-line text-2xl"></i></button>
                
                <h3 class="text-lg font-bold text-slate-800 mb-1">è´¦æˆ·å……å€¼</h3>
                <p class="text-sm text-slate-500 mb-6 border-b border-slate-100 pb-4">å……å€¼é‡‘é¢å°†è¿›å…¥æ‚¨çš„è´¦æˆ·ä½™é¢</p>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">å……å€¼é‡‘é¢ (USDT)</label>
                        <input v-model.number="rechargeForm.amount" type="number" min="1" step="0.0001" placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-50 focus:outline-none transition">
                        <div class="text-sm text-slate-400 mt-1">â‰ˆ Â¥{{ (rechargeForm.amount * settings.rate).toFixed(2) }} (æ±‡ç‡: {{settings.rate}})</div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-3">é€‰æ‹©æ”¯ä»˜æ–¹å¼</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div @click="rechargeForm.method = 'USDT'" :class="rechargeForm.method === 'USDT' ? 'border-brand-500 bg-brand-50 text-brand-700 ring-1 ring-brand-500' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'" class="border rounded-xl p-4 cursor-pointer transition flex flex-col items-center gap-2 text-center">
                                <i class="ri-money-dollar-circle-line text-2xl" :class="rechargeForm.method==='USDT'?'text-brand-600':'text-slate-400'"></i>
                                <div>
                                    <div class="text-sm font-bold">USDT</div>
                                    <div class="text-[10px] opacity-70">è‡ªåŠ¨åˆ°è´¦</div>
                                </div>
                            </div>
                            <div @click="rechargeForm.method = 'WeChat'" :class="rechargeForm.method === 'WeChat' ? 'border-brand-500 bg-brand-50 text-brand-700 ring-1 ring-brand-500' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'" class="border rounded-xl p-4 cursor-pointer transition flex flex-col items-center gap-2 text-center">
                                <i class="ri-wechat-pay-line text-2xl" :class="rechargeForm.method==='WeChat'?'text-brand-600':'text-slate-400'"></i>
                                <div>
                                    <div class="text-sm font-bold">å¾®ä¿¡</div>
                                    <div class="text-[10px] opacity-70">äººå·¥æ ¸å®åˆ°è´¦</div>
                                </div>
                            </div>
                            <div @click="rechargeForm.method = 'Alipay'" :class="rechargeForm.method === 'Alipay' ? 'border-brand-500 bg-brand-50 text-brand-700 ring-1 ring-brand-500' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'" class="border rounded-xl p-4 cursor-pointer transition flex flex-col items-center gap-2 text-center">
                                <i class="ri-alipay-line text-2xl" :class="rechargeForm.method==='Alipay'?'text-brand-600':'text-slate-400'"></i>
                                <div>
                                    <div class="text-sm font-bold">æ”¯ä»˜å®</div>
                                    <div class="text-[10px] opacity-70">äººå·¥æ ¸å®åˆ°è´¦</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button @click="submitRecharge" :disabled="rechargeSubmitting" class="w-full btn-gradient text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-500/20 disabled:opacity-50 flex justify-center text-sm tracking-wide">
                        <span v-if="rechargeSubmitting" class="animate-spin mr-2"><i class="ri-loader-4-line"></i></span>
                        ç¡®è®¤å……å€¼
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- æç°æ¨¡æ€æ¡† -->
    <transition name="modal">
        <div v-if="withdrawModal.open" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" @click.self="withdrawModal.open = false">
            <div class="bg-white rounded-2xl w-full max-w-lg p-6 modal-content relative shadow-2xl">
                <button @click="withdrawModal.open = false" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="ri-close-line text-2xl"></i></button>
                
               <h3 class="text-lg font-bold text-slate-800 mb-1">ä½™é¢æç°</h3>
<p class="text-sm text-slate-500 mb-6 border-b border-slate-100 pb-4">å¯æç°ä½™é¢: <span class="font-bold text-emerald-600">{{ parseFloat(user.balance || 0).toFixed(2) }} USDT</span></p>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">æç°æ–¹å¼</label>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <div @click="withdrawForm.method = 'USDT'" :class="withdrawForm.method === 'USDT' ? 'border-brand-500 bg-brand-50 text-brand-600 ring-1 ring-brand-500' : 'border-slate-200'" class="border rounded-lg p-3 text-center cursor-pointer text-sm font-bold transition">USDT</div>
                            <div @click="withdrawForm.method = 'WeChat'" :class="withdrawForm.method === 'WeChat' ? 'border-brand-500 bg-brand-50 text-brand-600 ring-1 ring-brand-500' : 'border-slate-200'" class="border rounded-lg p-3 text-center cursor-pointer text-sm font-bold transition">å¾®ä¿¡</div>
                            <div @click="withdrawForm.method = 'Alipay'" :class="withdrawForm.method === 'Alipay' ? 'border-brand-500 bg-brand-50 text-brand-600 ring-1 ring-brand-500' : 'border-slate-200'" class="border rounded-lg p-3 text-center cursor-pointer text-sm font-bold transition">æ”¯ä»˜å®</div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">æç°é‡‘é¢ (USDT)</label>
                        <input v-model.number="withdrawForm.amount" type="number" :max="user.balance" min="5" step="0.01" placeholder="æœ€ä½ 5 USDT" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-50 focus:outline-none transition">
                    </div>

                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-500">æç°æ±‡ç‡</span>
                            <span class="font-mono">{{ settings.rate }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">æ‰‹ç»­è´¹ ({{ withdrawForm.method === 'USDT' ? '0%' : '2%' }})</span>
                            <span class="text-red-500 font-mono">- {{ withdrawCalc.fee }}</span>
                        </div>
                        <div class="flex justify-between border-t border-slate-200 pt-2">
                            <span class="font-bold text-slate-800">é¢„è®¡åˆ°è´¦</span>
                            <span class="font-bold text-emerald-600 font-mono">{{ withdrawCalc.final }}</span>
                        </div>
                    </div>

                    <div v-if="withdrawForm.method === 'USDT'">
                        <label class="block text-sm font-bold text-slate-700 mb-2">TRC20 æ”¶æ¬¾åœ°å€</label>
                        <input v-model="withdrawForm.address" type="text" placeholder="Tå¼€å¤´..." class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-50 focus:outline-none transition mb-2">
                        <label class="flex items-center gap-2 text-xs text-slate-500 bg-orange-50 p-2 rounded border border-orange-100 cursor-pointer">
                            <input type="checkbox" v-model="withdrawForm.confirmAddr" class="w-4 h-4 text-brand-600 rounded">
                            <span>è¯·ç¡®è®¤åœ°å€æ˜¯å¦æ­£ç¡®ï¼Œåœ°å€é”™è¯¯æ‰“æ¬¾äº†æ¦‚ä¸è´Ÿè´£</span>
                        </label>
                    </div>

                    <div v-else>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ä¸Šä¼ æ”¶æ¬¾ç  </label>
                        <input v-model="withdrawForm.address" type="text" placeholder="è´¦å· (é€‰å¡«)" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm mb-2">
                        <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition cursor-pointer relative">
                            <input type="file" accept="image/*" @change="handleWithdrawFile" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
                            <div v-if="withdrawForm.preview" class="flex flex-col items-center">
                                <img :src="withdrawForm.preview" class="h-24 object-contain rounded mb-2 border">
                                <span class="text-xs text-emerald-500">å·²é€‰æ‹©å›¾ç‰‡</span>
                            </div>
                            <div v-else class="flex flex-col items-center text-slate-400">
                                <i class="ri-qr-code-line text-3xl mb-1"></i>
                                <span class="text-xs">ç‚¹å‡»ä¸Šä¼ æ”¶æ¬¾ç </span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-100 p-3 rounded-lg">
                        <div class="text-xs text-yellow-700">
                            <i class="ri-alert-line"></i> æç°ç”³è¯·æäº¤åï¼Œå®¢æœç¨åä¼šå¤„ç†ã€‚æœ€å°æç°é‡‘é¢ä¸º1 USDTï¼Œæ‰‹ç»­è´¹ä¸º1 USDTã€‚
                        </div>
                    </div>

                    <button @click="submitWithdraw" :disabled="withdrawSubmitting || withdrawForm.amount > (user.balance || 0)" class="w-full btn-gradient text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-500/20 disabled:opacity-50 flex justify-center text-sm tracking-wide">
                        <span v-if="withdrawSubmitting" class="animate-spin mr-2"><i class="ri-loader-4-line"></i></span>
                        æäº¤æç°ç”³è¯·
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- æ”¯ä»˜æˆåŠŸå‡­è¯ä¸Šä¼ æ¨¡æ€æ¡† -->
    <transition name="modal">
        <div v-if="paymentProofModal.open" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" @click.self="paymentProofModal.open = false">
            <div class="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-md modal-content relative shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="bg-gradient-to-r from-brand-500 to-brand-purple p-6 text-white text-center relative shrink-0">
                    <button @click="paymentProofModal.open = false" class="absolute top-4 right-4 text-white/70 hover:text-white bg-black/10 rounded-full w-8 h-8 flex items-center justify-center transition">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                    <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm">
                        <i class="ri-secure-payment-fill text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold">æäº¤æ”¯ä»˜å‡­è¯</h3>
                    <p class="text-xs text-blue-100 mt-1 font-mono tracking-wide opacity-80">ORDER: {{ paymentProofModal.orderId }}</p>
                </div>
                
                <div class="p-6 space-y-6 overflow-y-auto">
                    <div class="relative group">
                        <input type="file" id="payment-proof" accept="image/*" @change="handlePaymentProof" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition duration-300 group-hover:border-brand-500 group-hover:bg-brand-50" :class="{'border-emerald-500 bg-emerald-50': paymentProofModal.proofUrl}">
                            
                            <div v-if="!paymentProofModal.proofUrl">
                                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition duration-300">
                                    <i class="ri-image-add-line text-3xl text-slate-400 group-hover:text-brand-500"></i>
                                </div>
                                <h4 class="font-bold text-slate-700 mb-1">ç‚¹å‡»ä¸Šä¼ æˆªå›¾</h4>
                                <p class="text-xs text-slate-400">æ”¯æŒ JPG, PNG (æœ€å¤§ 5MB)</p>
                            </div>

                            <div v-else class="relative">
                                <img :src="paymentProofModal.proofUrl" class="w-full h-48 object-contain rounded-lg shadow-sm bg-white">
                                <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition rounded-lg">
                                    <span class="text-white font-bold text-sm"><i class="ri-refresh-line"></i> æ›´æ¢å›¾ç‰‡</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-orange-50 border border-orange-100 rounded-lg p-3 flex gap-3 items-start">
                        <i class="ri-alert-line text-orange-500 mt-0.5"></i>
                        <div class="text-xs text-orange-700 leading-relaxed">
                            è¯·ç¡®ä¿æˆªå›¾æ¸…æ™°åŒ…å« <span class="font-bold">è½¬è´¦é‡‘é¢</span> å’Œ <span class="font-bold">æ—¶é—´</span>ã€‚æ¶æ„ä¸Šä¼ æ— å…³å›¾ç‰‡å¯èƒ½å¯¼è‡´å°å·ã€‚
                        </div>
                    </div>

                    <button @click="submitPaymentProof" :disabled="paymentProofSubmitting || !paymentProofModal.proofUrl" class="w-full btn-gradient text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-500/25 hover:-translate-y-0.5 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span v-if="paymentProofSubmitting" class="animate-spin"><i class="ri-loader-4-line"></i></span>
                        <span v-else><i class="ri-send-plane-fill"></i> ç¡®è®¤æäº¤</span>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- è®°å½•æ¨¡æ€æ¡† -->
    <transition name="modal">
        <div v-if="recordModal.open" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" @click.self="recordModal.open = false">
            <div class="bg-white rounded-2xl w-full max-w-lg max-h-[80vh] flex flex-col shadow-2xl modal-content">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800">{{ recordModal.title }}</h3>
                    <button @click="recordModal.open = false"><i class="ri-close-line text-2xl text-slate-400"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <div v-if="recordModal.loading" class="text-center py-10 text-slate-400">åŠ è½½ä¸­...</div>
                    <div v-else-if="recordModal.list.length === 0" class="text-center py-10 text-slate-400">æš‚æ— è®°å½•</div>
                    <div v-else class="space-y-3">
                        <div v-for="(item, idx) in recordModal.list" :key="idx" class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="text-xs text-slate-400">{{ formatDate(item.created_at) }}</div>
                                    <div class="font-bold text-slate-700" v-if="item.order_id">å•å·: {{ item.order_id }}</div>
                                    <div class="font-bold text-slate-700" v-else>æç°ç”³è¯·</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-lg" :class="recordModal.type==='recharge'?'text-emerald-600':'text-orange-600'">
                                        {{ recordModal.type==='recharge' ? '+' : '-' }}{{ parseFloat(item.amount || item.usdt_amount || 0).toFixed(2) }}
                                    </div>
                                    <span class="text-xs bg-white border px-2 py-0.5 rounded">{{ item.status }}</span>
                                    
                                    <button v-if="recordModal.type === 'recharge' && item.status === 'å¾…æ”¯ä»˜'" @click="continueRecharge(item)" class="block mt-2 text-xs bg-brand-500 text-white px-3 py-1.5 rounded shadow-sm hover:bg-brand-600 transition ml-auto">
                                        å»æ”¯ä»˜ <i class="ri-arrow-right-line"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-if="item.address" class="text-xs text-slate-400 break-all">åœ°å€: {{ item.address }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>
<transition name="modal">
        <div v-if="balanceLogModal.open" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" @click.self="balanceLogModal.open = false">
            <div class="bg-white rounded-2xl w-full max-w-lg max-h-[80vh] flex flex-col shadow-2xl modal-content">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800">èµ„é‡‘å˜åŠ¨æ˜ç»†</h3>
                    <button @click="balanceLogModal.open = false"><i class="ri-close-line text-2xl text-slate-400"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <div v-if="balanceLogModal.loading" class="text-center py-10 text-slate-400">
                        <i class="ri-loader-4-line animate-spin text-2xl mb-2 block"></i>
                        åŠ è½½ä¸­...
                    </div>
                    <div v-else-if="balanceLogModal.list.length === 0" class="text-center py-10 text-slate-400">
                        <i class="ri-file-list-3-line text-4xl mb-2 block opacity-50"></i>
                        æš‚æ— èµ„é‡‘å˜åŠ¨
                    </div>
                    <div v-else class="space-y-3">
                        <div v-for="(log, idx) in balanceLogModal.list" :key="idx" class="bg-slate-50 rounded-xl p-4 border border-slate-100 flex justify-between items-center">
                            <div>
                                <div class="font-bold text-slate-700 text-sm mb-1">{{ log.description || log.type }}</div>
                                <div class="text-xs text-slate-400">{{ formatDate(log.created_at) }}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-mono font-bold text-lg" :class="parseFloat(log.amount) >= 0 ? 'text-emerald-600' : 'text-slate-800'">
                                    {{ parseFloat(log.amount) > 0 ? '+' : '' }}{{ parseFloat(log.amount) }} USDT
                                </div>
                                <div class="text-xs text-slate-400" v-if="log.balance_after">
                                    ä½™é¢: {{ parseFloat(log.balance_after) }} USDT
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</transition>
</div>
<script>

    const API_BASE = "https://wzmdxd.onrender.com";  

    // å…¨å±€æ‹¦æˆªå™¨å¤„ç† 401 Token è¿‡æœŸ
    axios.interceptors.response.use(response => response, error => {
        if (error.response && error.response.status === 401) {
            localStorage.removeItem('nexus_user');
            localStorage.removeItem('adminToken'); // å¦‚æœæ˜¯åå°
            Swal.fire({
                title: 'ç™»å½•å·²è¿‡æœŸ',
                text: 'è¯·é‡æ–°ç™»å½•',
                icon: 'warning',
                confirmButtonText: 'å»ç™»å½•'
            }).then(() => {
                window.location.reload();
            });
        }
        return Promise.reject(error);
    });

const app = Vue.createApp({
        data() {
            return {
                // ã€æ–°å¢ã€‘PWA ç›¸å…³å˜é‡
                deferredPrompt: null,
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,

                siteConfig: {
                    domainText: 'XAW888.COM',
                    bossName: 'Boss',
                    contactId: 'rrii8',
                    bossTitle: 'Boss'
                },

                view: 'home',
                profileTab: 'orders',
                user: JSON.parse(localStorage.getItem('nexus_user') || '{}'),

                products: [],
                categories: [],
                hiringList: [],
                myOrders: [],
                settings: { rate: 7.0, feeRate: 0, announcement: '', showPopup: false },
                
                loading: true,
                searchQuery: '',
                filterCat: 'all',
                mobileMenuOpen: false,

                // Invite
                inviteModal: { open: false, list: [], totalEarned: 0, loading: false },
                // Restock
                restockContact: '',

                // Auth
                authModal: { open: false, mode: 'login' },
                authForm: { contact: '', password: '', confirmPassword: '', captchaInput: '', inviteCode: '' },
                authSubmitting: false,
                captcha: { display: '', value: '' },

                // Product Detail
                productDetailModal: { open: false, prod: {} },
                currentImgIndex: 0,

                // Chat
                chatOpen: false,
                chatInput: '',
                chatMessages: [],
                chatPollTimer: null,
                chatSessionId: localStorage.getItem('chat_session_id') || 'guest_' + Date.now(),
                unreadMessages: 0,
                messageSound: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3'),

               // Buy
                buyModal: { open: false, prod: {} },
                buyForm: { method: 'USDT', shipName: '', shipTel: '', shipAddr: '', useBalance: false, balanceAmount: 0, contactInfo: '' },
                orderSubmitting: false,

                // Recharge
                rechargeModal: { open: false },
                rechargeForm: { amount: 10, method: 'USDT' },
                rechargeSubmitting: false,

               // Withdraw
                withdrawModal: { open: false },
                withdrawForm: { amount: 0, address: '', method: 'USDT' },
                withdrawSubmitting: false,

                recordModal: { open: false, title: '', list: [], loading: false, type: '' },

                // Payment Proof
                paymentProofModal: { open: false, orderId: '', proofUrl: '' },
                paymentProofSubmitting: false,

                // Security
                securityForm: { oldPassword: '', newPassword: '', confirmPassword: '' },

                // Balance Logs
                balanceLogModal: { open: false, list: [], loading: false },

                // Cart
                cartItems: JSON.parse(localStorage.getItem('nexus_cart') || '[]'),
                
                // Order Timers
                orderTimers: {},
                notifiedQRCodes: JSON.parse(sessionStorage.getItem('notified_qrs') || '[]'),
                chatInitialized: false,
                socket: null,
            }
        },
        computed: {
          filteredProducts() {
                let list = this.products;
                if (this.searchQuery) {
                    const q = this.searchQuery.toLowerCase();
                    // ã€ä¿®å¤ã€‘å¢åŠ  (p.description || '') é˜²æ­¢ null æŠ¥é”™
                    list = list.filter(p => p.name.toLowerCase().includes(q) || (p.description || '').toLowerCase().includes(q));
                }
                if (this.filterCat !== 'all') {
                    list = list.filter(p => p.category === this.filterCat);
                }
                return list;
            },
            currentProdImgs() {
                return this.getImgList(this.productDetailModal.prod);
            },
           cartTotal() {
    const total = this.cartItems.reduce((acc, item) => {
        return acc + (parseFloat(item.price) * (item.quantity || 1));
    }, 0);
return parseFloat(total.toFixed(2));
},
isServiceOnline() {
    // æŸ¬åŸ”å¯¨æ—¶é—´ UTC+7ï¼Œ12:00 - 24:00
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const cambodiaTime = new Date(utc + (3600000 * 7));
    const hour = cambodiaTime.getHours();
    return hour >= 12 && hour < 24;
},
withdrawCalc() {
    const amt = parseFloat(this.withdrawForm.amount) || 0;
    const isUsdt = this.withdrawForm.method === 'USDT';
    // ç»Ÿä¸€æ‰‹ç»­è´¹è®¡ç®—é€»è¾‘
    const feePercent = isUsdt ? 0 : 0.02;
    const feeVal = amt * feePercent;
    
    // è®¡ç®—æœ€ç»ˆé‡‘é¢
    const finalAmount = amt - feeVal;
    
    let finalVal = "";
    let feeDisplay = "";

    if (isUsdt) {
        // USDT æ¨¡å¼ï¼šå¼ºåˆ¶ 2 ä½å°æ•°æ˜¾ç¤º
        finalVal = finalAmount.toFixed(2) + ' USDT';
        feeDisplay = feeVal.toFixed(2) + ' USDT';
    } else {
        // å¾®ä¿¡/æ”¯ä»˜å®æ¨¡å¼ï¼šè®¡ç®—äººæ°‘å¸é‡‘é¢
        const cnyVal = finalAmount * this.settings.rate;
        finalVal = 'Â¥' + cnyVal.toFixed(2);
        // æ‰‹ç»­è´¹éƒ¨åˆ†æ˜¾ç¤ºï¼šUSDTé‡‘é¢ + äººæ°‘å¸ä¼°å€¼
        feeDisplay = feeVal.toFixed(2) + ' USDT (çº¦ Â¥' + (feeVal * this.settings.rate).toFixed(2) + ')';
    }
    
    return {
        fee: feeDisplay,
        final: finalVal
    };
}
        },
        created() {
            const host = window.location.hostname;
            if (host.includes('xaw8888')) {
                this.siteConfig = {
                    domainText: 'XAW8888.COM',
                    bossName: 'é¾å“¥',
                    contactId: 'iibb8',
                    bossTitle: 'é¾å“¥'
                };
            } else {
                this.siteConfig = {
                    domainText: 'XAW888.COM',
                    bossName: 'Boss',
                    contactId: 'rrii8',
                    bossTitle: 'Boss'
                };
            }

this.initData(); // æå‰åŠ è½½æ•°æ®
        },
mounted() {
            // ã€æ–°å¢ã€‘ç›‘å¬å®‰å“ PWA å®‰è£…äº‹ä»¶
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                this.deferredPrompt = e;
            });
            window.addEventListener('appinstalled', () => {
                this.deferredPrompt = null;
            });

            localStorage.setItem('chat_session_id', this.chatSessionId);
            this.genCaptcha();
            this.startOrderTimers();
            this.initSocket();
            this.pollChat();
            // setInterval(() => {
            //     if (!document.hidden) this.pollUpdates();
            // }, 8000); // å·²æ”¹ç”¨ WebSocket

            // [æ–°å¢] ç›‘å¬ç‰©ç†è¿”å›é”®ï¼Œå¦‚æœæœ‰å¼¹çª—æ‰“å¼€ï¼Œåˆ™å…³é—­å¼¹çª—è€Œä¸æ˜¯é€€å‡º
            window.addEventListener('popstate', (e) => {
                // å¦‚æœæœ‰ä»»ä½•æ¨¡æ€æ¡†æ‰“å¼€ï¼Œé˜»æ­¢è¿”å›å¹¶å…³é—­å®ƒä»¬
                if (this.chatOpen || this.productDetailModal.open || this.buyModal.open || this.authModal.open || this.rechargeModal.open || this.withdrawModal.open || this.inviteModal.open || this.recordModal.open || this.balanceLogModal.open) {
                    this.chatOpen = false;
                    this.productDetailModal.open = false;
                    this.buyModal.open = false;
                    this.authModal.open = false;
                    this.rechargeModal.open = false;
                    this.withdrawModal.open = false;
                    this.inviteModal.open = false;
                    this.recordModal.open = false;
                    this.balanceLogModal.open = false;
                }
            });
        },
beforeUnmount() {
            if(this.chatPollTimer) clearInterval(this.chatPollTimer);
            Object.values(this.orderTimers).forEach(timer => clearInterval(timer));
        },
        methods: {
// ã€æ–°å¢ã€‘æ˜¾ç¤ºæ·»åŠ åˆ°æ¡Œé¢å¼•å¯¼
            showAddToHomeGuide(source = 'user') {
                // 1. å¦‚æœå·²ç»æ˜¯APPæ¨¡å¼ï¼Œæç¤ºå¹¶é€€å‡º
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                    if(source === 'user') {
                        const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 2000 });
                        Toast.fire({ icon: 'success', title: 'å½“å‰å·²æ˜¯APPæ¨¡å¼' });
                    }
                    return;
                }

                // å®šä¹‰ä½ çš„ä¸“å± Logo HTML (å’Œé¡¶éƒ¨å¯¼èˆªæ ä¸€è‡´)
                const myLogoHtml = `
                    <div class="w-20 h-20 rounded-full bg-black flex items-center justify-center text-[#00ff41] shadow-[0_0_20px_rgba(0,255,65,0.4)] border border-[#00ff41]/60 mb-4 animate-pulse">
                        <i class="ri-spy-fill text-4xl"></i>
                    </div>
                `;

                // iOS å¼•å¯¼ HTML (ç¾åŒ–ç‰ˆ)
                const iosGuideHtml = `
                    <div class="relative overflow-hidden pb-2">
                        <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-blue-600 to-indigo-600 -mt-6"></div>
                        <div class="relative z-10 flex flex-col items-center pt-8">
                            ${myLogoHtml}
                            <h3 class="text-xl font-black text-slate-800 mb-1">æ·»åŠ åˆ°ä¸»å±å¹•</h3>
                            <p class="text-xs text-slate-500 mb-6 px-4">é˜²æ­¢åŸŸåä¸¢å¤±ï¼Œè·å¾—åŸç”Ÿ APP ä½“éªŒ</p>
                            
                            <div class="w-full bg-slate-50 rounded-xl p-5 text-left border border-slate-100 space-y-4 shadow-inner mx-4">
                                <div class="flex items-start gap-4">
                                    <div class="w-8 h-8 rounded-full bg-white text-blue-600 border border-blue-100 flex items-center justify-center text-sm font-bold shadow-sm shrink-0">1</div>
                                    <div class="text-sm text-slate-600 leading-snug pt-1">
                                        ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„ <span class="inline-flex items-center justify-center w-6 h-6 bg-slate-200 rounded mx-1 text-blue-600"><i class="ri-upload-2-line"></i></span> åˆ†äº«æŒ‰é’®
                                    </div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="w-8 h-8 rounded-full bg-white text-blue-600 border border-blue-100 flex items-center justify-center text-sm font-bold shadow-sm shrink-0">2</div>
                                    <div class="text-sm text-slate-600 leading-snug pt-1">
                                        ä¸Šæ»‘èœå•æ‰¾åˆ° <span class="font-bold text-slate-800 bg-white px-2 py-0.5 rounded border border-slate-200 text-xs shadow-sm">æ·»åŠ åˆ°ä¸»å±å¹•</span>
                                    </div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="w-8 h-8 rounded-full bg-white text-blue-600 border border-blue-100 flex items-center justify-center text-sm font-bold shadow-sm shrink-0">3</div>
                                    <div class="text-sm text-slate-600 leading-snug pt-1">
                                        ç‚¹å‡»å³ä¸Šè§’çš„ <span class="text-blue-600 font-bold">"æ·»åŠ "</span> å³å¯
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // å®‰å“ å¼•å¯¼ HTML (ç¾åŒ–ç‰ˆ - é’ˆå¯¹ Chrome)
                const androidGuideHtml = `
                    <div class="relative overflow-hidden pb-2">
                        <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-emerald-500 to-teal-600 -mt-6"></div>
                        <div class="relative z-10 flex flex-col items-center pt-8">
                            ${myLogoHtml}
                            <h3 class="text-xl font-black text-slate-800 mb-1">å®‰è£…åº”ç”¨</h3>
                            <p class="text-xs text-slate-500 mb-6 px-4">è·å¾—å…¨å±ä½“éªŒï¼Œé˜²æ­¢åŸŸåä¸¢å¤±ï¼Œè®¿é—®æ›´ç¨³å®š</p>

                            <div class="w-full bg-slate-50 rounded-xl p-5 text-left border border-slate-100 space-y-4 shadow-inner mx-4">
                                <div class="flex items-start gap-4">
                                    <div class="w-8 h-8 rounded-full bg-white text-emerald-600 border border-emerald-100 flex items-center justify-center text-sm font-bold shadow-sm shrink-0">1</div>
                                    <div class="text-sm text-slate-600 leading-snug pt-1">
                                        ç‚¹å‡»å³ä¸Šè§’çš„ <span class="inline-flex items-center justify-center w-6 h-6 bg-slate-200 rounded mx-1 text-slate-600"><i class="ri-more-2-fill"></i></span> èœå•å›¾æ ‡
                                    </div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="w-8 h-8 rounded-full bg-white text-emerald-600 border border-emerald-100 flex items-center justify-center text-sm font-bold shadow-sm shrink-0">2</div>
                                    <div class="text-sm text-slate-600 leading-snug pt-1">
                                        é€‰æ‹© <span class="font-bold text-slate-800 bg-white px-2 py-0.5 rounded border border-slate-200 text-xs shadow-sm"><i class="ri-download-cloud-2-line"></i> å®‰è£…åº”ç”¨</span>
                                    </div>
                                </div>
                                <div class="p-2 bg-blue-50 text-blue-600 text-xs rounded-lg text-center border border-blue-100">
                                    å¦‚æœæ— æ³•å®‰è£…ï¼Œè¯·ä½¿ç”¨ Chrome æµè§ˆå™¨è®¿é—®
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // 2. åˆ¤æ–­è®¾å¤‡å¼¹å‡ºä¸åŒæ ·å¼
                if (this.isIOS) {
                    Swal.fire({
                        html: iosGuideHtml,
                        showConfirmButton: true,
                        confirmButtonText: 'æˆ‘çŸ¥é“äº†',
                        confirmButtonColor: '#3b82f6',
                        customClass: { popup: 'rounded-3xl', content: 'p-0' },
                        buttonsStyling: false,
                        didOpen: () => {
                            const btn = Swal.getConfirmButton();
                            btn.className = 'w-full mt-4 btn-gradient text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition';
                        }
                    });
                } else {
                    // å®‰å“é€»è¾‘ï¼šä¼˜å…ˆå°è¯•è‡ªåŠ¨æ‹‰èµ·ï¼Œä¸è¡Œåˆ™æ˜¾ç¤ºæ‰‹åŠ¨æ•™ç¨‹
                    Swal.fire({
                        html: androidGuideHtml,
                        showConfirmButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'ç«‹å³å®‰è£…',
                        cancelButtonText: 'æˆ‘çŸ¥é“äº†',
                        confirmButtonColor: '#10b981',
                        cancelButtonColor: '#64748b',
                        customClass: { popup: 'rounded-3xl', content: 'p-0' },
                        buttonsStyling: false,
                        didOpen: () => {
                            const btn = Swal.getConfirmButton();
                            const cancelBtn = Swal.getCancelButton();
                            btn.className = 'flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition mr-2';
                            cancelBtn.className = 'flex-1 bg-slate-100 text-slate-500 font-bold py-3 rounded-xl hover:bg-slate-200 active:scale-95 transition ml-2';
                            
                            // è°ƒæ•´æŒ‰é’®å®¹å™¨å¸ƒå±€
                            const actions = Swal.getActions();
                            actions.className = 'swal2-actions w-full px-5 pb-5 pt-2 flex gap-2';
                        }
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            // å°è¯•è§¦å‘è‡ªåŠ¨å®‰è£…
                            if (this.deferredPrompt) {
                                this.deferredPrompt.prompt();
                                const { outcome } = await this.deferredPrompt.userChoice;
                                if (outcome === 'accepted') this.deferredPrompt = null;
                            } else {
                                // å¦‚æœæ— æ³•è‡ªåŠ¨è§¦å‘ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
                                const Toast = Swal.mixin({ toast: true, position: 'center', showConfirmButton: false, timer: 3000 });
                                Toast.fire({ icon: 'info', title: 'è¯·æŒ‰ä¸Šå›¾æŒ‡å¼•æ‰‹åŠ¨ç‚¹å‡»èœå•å®‰è£…' });
                            }
                        }
                    });
                }
            },

initSocket() {
                if (this.socket) {
                    this.socket.disconnect();
                }
                // [ä¿®æ”¹] å¼ºåˆ¶ä½¿ç”¨ WebSocket åè®®ï¼Œè§£å†³ Render ä¸Šçš„ 400 è½®è¯¢é”™è¯¯
                this.socket = io(API_BASE, {
                    transports: ['websocket'], 
                    reconnection: true
                });
                const sid = this.user.id ? `user_${this.user.id}` : this.chatSessionId;
                
                this.socket.on('connect', () => {
                    this.socket.emit('join_room', sid);
                });

                // ã€æ–°å¢ã€‘ç›‘å¬å…¨å±€å•†å“æ›´æ–° (æ›¿ä»£ pollUpdates)
                this.socket.on('global_update', (data) => {
                    this.products = data.products || [];
                    this.categories = data.categories || [];
                    this.settings.rate = data.rate;
                    this.settings.feeRate = data.feeRate;
                    this.settings.announcement = data.announcement;
                    
                    // [æ–°å¢] å®æ—¶æ›´æ–°æ‹›è˜å’Œå¼¹çª—è®¾ç½®
                    if (data.hiring) this.hiringList = data.hiring;
                    if (data.showPopup !== undefined) this.settings.showPopup = data.showPopup;
                });

// ã€æ–°å¢ã€‘ç›‘å¬è®¢å•å’Œä½™é¢æ›´æ–° (å®¢æœæ“ä½œåè‡ªåŠ¨åˆ·æ–°)
                this.socket.on('order_update', () => {
                    if (this.user.id) {
                        this.loadOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
                        this.loadUserBalance(); // åˆ·æ–°ä½™é¢
                        
                        // [æ–°å¢] å¦‚æœé‚€è¯·æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œç«‹å³é‡æ–°åŠ è½½é‚€è¯·æ•°æ®ï¼Œå®ç°å®æ—¶è·³åŠ¨
                        if (this.inviteModal.open) {
                            this.openInviteModal();
                        }

                        
                        //const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 3000 });
                        //Toast.fire({ icon: 'info', title: 'å·²åˆ·æ–°' });
                    }
                });

                this.socket.on('new_message', (msg) => {
                    if (msg.session_id === sid) {
                        this.chatMessages.push(msg);
                        this.$nextTick(() => {
                            const box = document.getElementById('chat-msgs');
                            if(box) box.scrollTop = box.scrollHeight;
                            
                            if (msg.sender === 'admin') {
                                this.messageSound.play().catch(()=>{});
                                if (!this.chatOpen) {
                                    this.unreadMessages++;
                                    this.showChatNotification(msg.msg_type === 'image' ? '[å›¾ç‰‡]' : msg.content);
                                }
                            }
                        });
                    }
                });
            },

            async sendChatImage(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.size > 2 * 1024 * 1024) {
                    Swal.fire('æ–‡ä»¶è¿‡å¤§', 'è¯·ä¸Šä¼ å°äº 2MB çš„å›¾ç‰‡', 'warning');
                    return;
                }

                const tempId = Date.now();
                this.chatMessages.push({
                    sender: 'user',
                    content: 'å›¾ç‰‡ä¸Šä¼ ä¸­...',
                    msg_type: 'text',
                    id: tempId
                });
                this.$nextTick(() => {
                    const box = document.getElementById('chat-msgs');
                    if(box) box.scrollTop = box.scrollHeight;
                });

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    const uploadRes = await axios.post(`${API_BASE}/api/chat/upload`, formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });
                    
                    if (uploadRes.data.success) {
                        const imgUrl = uploadRes.data.url;
                        const sid = this.user.id ? `user_${this.user.id}` : this.chatSessionId;
                        
                        await axios.post(`${API_BASE}/api/chat/send`, {
                            sessionId: sid,
                            text: imgUrl,
                            msgType: 'image'
                        });
                        
                        this.chatMessages = this.chatMessages.filter(m => m.id !== tempId);
                    }
                } catch (e) {
                    Swal.fire('å‘é€å¤±è´¥', 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'error');
                    this.chatMessages = this.chatMessages.filter(m => m.id !== tempId);
                }
                event.target.value = '';
            },
            async initData() {
                this.loading = true;
                try {
                    const res = await axios.get(`${API_BASE}/api/public/data`);
                    const d = res.data;
                    this.products = d.products || [];
                    this.categories = d.categories || [];
                    this.hiringList = d.hiring || [];
                    this.settings = {
                        rate: d.rate,
                        feeRate: d.feeRate,
                        announcement: d.announcement,
                        showPopup: d.showPopup,
                        wallet: d.wallet
                    };

                    // [ä¿®æ”¹] å¼¹çª—æ—¶é—´æ§åˆ¶é€»è¾‘
                    if (this.settings.showPopup && this.settings.showPopup !== 'false' && this.settings.announcement) {
                        const duration = parseInt(this.settings.showPopup); // è·å–åå°è®¾ç½®çš„æ¯«ç§’æ•°
                        const lastPopStr = localStorage.getItem('nexus_last_pop'); // è·å–ä¸Šæ¬¡å¼¹çª—æ—¶é—´
                        const now = Date.now();
                        
                        // å¦‚æœä»æ²¡å¼¹è¿‡ï¼Œæˆ–è€… (å½“å‰æ—¶é—´ > ä¸Šæ¬¡æ—¶é—´ + é—´éš”æ—¶é—´)
                        if (!lastPopStr || (now > parseInt(lastPopStr) + duration)) {
                            Swal.fire({
                                title: 'å¹³å°å…¬å‘Š',
                                text: this.settings.announcement,
                                icon: 'info',
                                confirmButtonColor: '#3b82f6',
                                confirmButtonText: 'æˆ‘çŸ¥é“äº†'
                            });
                            // è®°å½•æœ¬æ¬¡å¼¹çª—çš„æ—¶é—´
                            localStorage.setItem('nexus_last_pop', now.toString());
                        }
                    }
                    if (this.user.id) {
                        this.loadOrders();
                        this.loadUserBalance();
                    }

                } catch (e) {
                    console.error(e);
                } finally {
                    this.loading = false;
                }
            },

            async loadUserBalance() {
                try {
                    const res = await axios.get(`${API_BASE}/api/user/balance?userId=${this.user.id}`);
                    if (res.data.success) {
                        this.user.balance = res.data.balance;
                        localStorage.setItem('nexus_user', JSON.stringify(this.user));
                    }
                } catch (e) {
                    console.error("åŠ è½½ä½™é¢å¤±è´¥", e);
                }
            },

async loadOrders() {
                try {
                    const res = await axios.get(`${API_BASE}/api/order?userId=${this.user.id}`);
                    this.myOrders = res.data || [];
                    this.startOrderTimers();
                    
                    // [ä¿®å¤] æ¯æ¬¡åŠ è½½è®¢å•åï¼Œè‡ªåŠ¨æ£€æŸ¥æœ‰æ²¡æœ‰æ–°çš„äºŒç»´ç éœ€è¦å¼¹çª—
                    this.checkQRCodes(); 
                } catch (e) {
                    console.error("åŠ è½½è®¢å•å¤±è´¥", e);
                }
            },

            // [æ–°å¢] ä¸“é—¨ç”¨æ¥æ£€æŸ¥äºŒç»´ç å¹¶å¼¹çª—çš„å‡½æ•°
            checkQRCodes() {
                this.myOrders.forEach(order => {
                    // å¦‚æœè®¢å•æ˜¯å¾…æ”¯ä»˜ï¼Œä¸”æœ‰äºŒç»´ç ï¼Œä¸”æ²¡æœ‰å¼¹è¿‡çª—ï¼Œä¸”æ²¡è¿‡æœŸ
                    if (order.status === 'å¾…æ”¯ä»˜' && order.qrcode_url && !this.notifiedQRCodes.includes(order.order_id) && !this.isOrderExpired(order)) {
                        
                        // æ ‡è®°ä¸ºå·²å¼¹çª—ï¼Œé˜²æ­¢é‡å¤å¼¹
                        this.notifiedQRCodes.push(order.order_id); 
                        sessionStorage.setItem('notified_qrs', JSON.stringify(this.notifiedQRCodes));
                        
                        // è§¦å‘åŸæ¥çš„äºŒç»´ç å¼¹çª—é€»è¾‘ (å¤ç”¨ä½ å·²æœ‰çš„ showPaymentInfo æˆ– manual logic)
                        // è¿™é‡Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨ showPaymentInfoï¼Œå®ƒä¼šè‡ªåŠ¨è¯†åˆ«äºŒç»´ç å¹¶æ˜¾ç¤º
                        this.showPaymentInfo(order);
                        
                        // æ’­æ”¾æç¤ºéŸ³
                        this.messageSound.play().catch(()=>{});
                    }
                });
            },

            setView(v) {
                if (v === 'products') {
                    this.view = 'home';
                    this.filterCat = 'all'; 
                } else {
                    this.view = v;
                    if(v === 'home') this.filterCat = 'all';
                }
                this.mobileMenuOpen = false;
            },
            
checkLoginAndGo(target) {
                if (!this.user.id) {
                    this.openAuth('login');
                    return;
                }
                if (target === 'orders_page') {
                    this.view = 'orders_page';
                    this.loadOrders();
                } else if (target === 'profile') {
                    this.view = 'profile';
                }
                this.mobileMenuOpen = false;
            },

            // è¯¦æƒ…ä¸å›¾ç‰‡é€»è¾‘
            openProductDetail(prod) {
                // [æ–°å¢] å†™å…¥å†å²è®°å½•ï¼Œé˜²æ­¢ç‚¹è¿”å›é”®ç›´æ¥é€€å‡ºç½‘ç«™
                history.pushState({ modal: 'product' }, null, '');
                this.productDetailModal.prod = prod;
                this.currentImgIndex = 0;
                this.productDetailModal.open = true;
            },
            
            getImgList(prod) {
                if(!prod) return [];
                try {
                    const imgs = JSON.parse(prod.image_url);
                    if (Array.isArray(imgs)) {
                        return imgs.map(url => {
                            if (!url) return '';
                            if (url.startsWith('data:')) return url; 
                            return url.startsWith('http') ? url : `${API_BASE}${url}`;
                        }).filter(url => url);
                    }
                    return [];
                } catch (e) {
                    // å¦‚æœä¸æ˜¯JSONï¼Œå°è¯•ä½œä¸ºå­—ç¬¦ä¸²å¤„ç†
                    if (prod.image_url) {
                        const url = prod.image_url;
                        if (url.startsWith('data:')) return [url];
                        return [url.startsWith('http') ? url : `${API_BASE}${url}`];
                    }
                    return [];
                }
            },
            
            handleImageError(event) {
                event.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24"><rect width="24" height="24" fill="%23e2e8f0"/><text x="12" y="12" text-anchor="middle" dy=".3em" fill="%2394a3b8" font-size="10">å›¾ç‰‡</text></svg>';
            },
            
            nextImage() {
                const len = this.currentProdImgs.length;
                if(len > 1) {
                    this.currentImgIndex = (this.currentImgIndex + 1) % len;
                }
            },
            prevImage() {
                const len = this.currentProdImgs.length;
                if(len > 1) {
                    this.currentImgIndex = (this.currentImgIndex - 1 + len) % len;
                }
            },

           // å®¢æœé€»è¾‘
            toggleChat() {
                this.chatOpen = !this.chatOpen;
                if(this.chatOpen) {
                    // [æ–°å¢] æ‰“å¼€æ—¶æ¨å…¥å†å²è®°å½•ï¼Œè¿™æ ·æŒ‰è¿”å›é”®å°±æ˜¯ popstate è€Œä¸æ˜¯é€€å‡º
                    history.pushState({ modal: 'chat' }, null, '');
                    
                    this.pollChat(); // ç«‹å³æ‹‰å–ä¸€æ¬¡
                    this.unreadMessages = 0; // æ¸…ç©ºæœªè¯»å°çº¢ç‚¹
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    this.$nextTick(() => {
                        const box = document.getElementById('chat-msgs');
                        if(box) box.scrollTop = box.scrollHeight;
                    });
                }
            },
            
            // [æ–°ä»£ç ] ä¼˜åŒ–è½®è¯¢é€»è¾‘ï¼šçª—å£å…³é—­ä¹Ÿèƒ½æ”¶åˆ°é€šçŸ¥
           async pollChat() {
                if (!this.user.id && !this.chatSessionId) return;

                try {
                    const sid = this.user.id ? `user_${this.user.id}` : this.chatSessionId;
                    const res = await axios.get(`${API_BASE}/api/chat/history/${sid}`);
                    const newMessages = res.data || [];
                    const oldLength = this.chatMessages.length;
                    
                    if (this.chatOpen) {
                        this.chatMessages = newMessages;
                        if (newMessages.length > oldLength) {
                            this.$nextTick(() => {
                                const box = document.getElementById('chat-msgs');
                                if(box) box.scrollTop = box.scrollHeight;
                                this.messageSound.play().catch(()=>{});
                            });
                        }
                    } 
                    else {
                        const adminMsgs = newMessages.filter(m => m.sender === 'admin');
                        const lastAdminMsg = adminMsgs.length > 0 ? adminMsgs[adminMsgs.length - 1] : null;
                        
                        if (newMessages.length > oldLength) {
                            // åªæœ‰åˆå§‹åŒ–å®Œæˆåï¼Œä¸”ç¡®å®æœ‰æ–°æ¶ˆæ¯æ‰å¼¹çª—
                            if (this.chatInitialized && lastAdminMsg) {
                                this.unreadMessages = newMessages.filter(m => m.sender === 'admin' && !m.is_read).length;
                                this.messageSound.play().catch(()=>{});
                                this.showChatNotification(lastAdminMsg.content);
                            }
                        }
                        this.chatMessages = newMessages;
                        this.chatInitialized = true; // æ ‡è®°åˆå§‹åŒ–å®Œæˆ
                    }
                } catch(e){}
            },

            // [æ–°ä»£ç ] æ–°å¢ï¼šæ˜¾ç¤ºä¸æ»‘çš„å³ä¸Šè§’é€šçŸ¥
            showChatNotification(text) {
                // ä½¿ç”¨ SweetAlert2 çš„ Toast æ¨¡å¼
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end', // å³ä¸Šè§’å¼¹å‡º
                    showConfirmButton: false,
                    timer: 5000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                        toast.addEventListener('click', () => {
                            // ç‚¹å‡»é€šçŸ¥ï¼Œè‡ªåŠ¨æ‰“å¼€èŠå¤©æ¡†
                            this.chatOpen = true; 
                            this.unreadMessages = 0;
                            this.$nextTick(() => {
                                const box = document.getElementById('chat-msgs');
                                if(box) box.scrollTop = box.scrollHeight;
                            });
                            Swal.close();
                        })
                    }
                });

                Toast.fire({
                    icon: 'info',
                    title: 'å®¢æœå‘æ¥æ–°æ¶ˆæ¯',
                    text: text,
                    background: '#ffffff',
                    color: '#334155',
                    iconColor: '#3b82f6'
                });
            },
            
           async sendMessage() {
                const txt = this.chatInput.trim();
                if(!txt) return;
                
                const sid = this.user.id ? `user_${this.user.id}` : this.chatSessionId;
                
                try {
                    await axios.post(`${API_BASE}/api/chat/send`, { 
                        sessionId: sid, 
                        text: txt,
                        msgType: 'text',
                        source: window.location.hostname
                    });
                    this.chatInput = '';
                } catch(e){}
            },

            // è®¤è¯é€»è¾‘
            openAuth(mode) {
                // [æ–°å¢] å†™å…¥å†å²è®°å½•
                history.pushState({ modal: 'auth' }, null, '');
                this.authModal.mode = mode;
                this.authModal.open = true;
                this.authForm = { contact: '', password: '', confirmPassword: '', captchaInput: '', inviteCode: '' };
                this.mobileMenuOpen = false;
                this.genCaptcha();
            },
            
            toggleAuthMode() {
                this.authModal.mode = this.authModal.mode === 'login' ? 'register' : 'login';
                this.genCaptcha();
            },
            
            genCaptcha() {
                const num = Math.floor(1000 + Math.random() * 9000).toString();
                this.captcha.value = num;
                this.captcha.display = num.split('').join(' ');
                this.authForm.captchaInput = '';
            },
            
async handleAuth() {
                if (this.authForm.captchaInput !== this.captcha.value) {
                    Swal.fire('éªŒè¯å¤±è´¥', 'éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
                    this.genCaptcha();
                    return;
                }

                if (this.authModal.mode === 'register') {
                    if (this.authForm.password.length < 6) {
                         Swal.fire('éªŒè¯æç¤º', 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½', 'warning');
                         return;
                    }
                    if (this.authForm.password !== this.authForm.confirmPassword) {
                        Swal.fire('éªŒè¯æç¤º', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'warning');
                        return;
                    }
                }

// è‡ªåŠ¨å°†é‚€è¯·ç è½¬ä¸ºå¤§å†™
                if (this.authForm.inviteCode) {
                    this.authForm.inviteCode = this.authForm.inviteCode.toUpperCase();
                }

                this.authSubmitting = true;
                try {
                    const uid = Math.floor(1000 + Math.random() * 9000);
                    
                    const endpoint = this.authModal.mode === 'login' ? '/api/user/login' : '/api/user/register';
                    const res = await axios.post(`${API_BASE}${endpoint}`, {
                        contact: this.authForm.contact,
                        password: this.authForm.password,
                        uid: this.authModal.mode === 'register' ? uid : undefined,
                        inviteCode: this.authForm.inviteCode,
                        source: window.location.hostname // ã€æ–°å¢ã€‘å‘Šè¯‰åå°è¿™æ˜¯å“ªä¸ªåŸŸåçš„ç”¨æˆ·
                    });

                    if (res.data.success) {
                        this.user = { 
                            id: res.data.userId, 
                            contact: this.authForm.contact,
                            uid: res.data.uid || uid,
                            balance: res.data.balance || 0,
                            inviteCode: res.data.inviteCode // ç¡®ä¿ä¿å­˜é‚€è¯·ç 
                        };
                        localStorage.setItem('nexus_user', JSON.stringify(this.user));
                        this.authModal.open = false;
                        
                        Swal.fire({
                            icon: 'success',
                            title: res.data.isNew ? 'æ³¨å†ŒæˆåŠŸ' : 'æ¬¢è¿å›æ¥',
                            text: 'å·²æˆåŠŸç™»å½•è´¦å·',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        this.loadOrders();
                        this.loadUserBalance();
                        this.initSocket();
                        this.pollChat();
                    } else {
                        Swal.fire(this.authModal.mode === 'login'?'ç™»å½•å¤±è´¥':'æ³¨å†Œå¤±è´¥', res.data.msg, 'error');
                    }
                } catch (e) {
                    Swal.fire('ç³»ç»Ÿé”™è¯¯', 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
                } finally {
                    this.authSubmitting = false;
                }
            },
            
           logout() {
                localStorage.removeItem('nexus_user');
                this.user = {};
                this.view = 'home';
                this.myOrders = [];
                this.cartItems = [];
                localStorage.removeItem('nexus_cart');
                this.initSocket();
                this.chatMessages = [];
                this.unreadMessages = 0;
                Swal.fire({
                    icon: 'success',
                    title: 'å·²é€€å‡º',
                    timer: 1000,
                    showConfirmButton: false
                });
            },

            // è´­ä¹°é€»è¾‘
            openBuyModal(prod) {
                this.productDetailModal.open = false; 
                if (!this.user.id) return this.openAuth('login');
                history.pushState({ modal: 'buy' }, null, '');
                this.buyModal.prod = prod;
                this.buyModal.open = true;
                this.buyForm = { 
                    method: 'USDT', 
                    shipName: '', 
                    shipTel: '', 
                    shipAddr: '',
                    useBalance: false,
                    balanceAmount: 0
                };
            },
            
            calculateCNY(usdtPrice) {
                let base = usdtPrice * this.settings.rate;
                if (this.settings.feeRate > 0) {
                    base += base * (this.settings.feeRate / 100);
                }
                return base.toFixed(2);
            },
            
            calculateFinalAmount(usdtPrice) {
                let finalAmount = parseFloat(usdtPrice);
                
                if (this.buyForm.useBalance && this.buyForm.balanceAmount > 0) {
                    finalAmount = Math.max(0, finalAmount - this.buyForm.balanceAmount);
                }
                
                if (this.buyForm.method === 'USDT') {
                    return finalAmount.toFixed(2) + ' USDT';
                } else {
                    let cnyAmount = finalAmount * this.settings.rate;
                    if (this.settings.feeRate > 0) {
                        cnyAmount += cnyAmount * (this.settings.feeRate / 100);
                    }
                    return 'Â¥' + cnyAmount.toFixed(2);
                }
            },

            isOrderExpired(order) {
                if (!order.expires_at) return false;
                return new Date() > new Date(order.expires_at);
            },
            
async submitOrder() {
                if (!this.buyForm.contactInfo) {
                    return Swal.fire('æç¤º', 'è¯·å¡«å†™æ¥æ”¶é€šçŸ¥çš„ é‚®ç®± æˆ– Telegram', 'warning');
                }

                if (this.buyModal.prod.type === 'physical') {
                    if (!this.buyForm.shipName || !this.buyForm.shipTel || !this.buyForm.shipAddr) {
                        return Swal.fire('æç¤º', 'è¯·å¡«å†™å®Œæ•´çš„æ”¶è´§ä¿¡æ¯', 'warning');
                    }
                }

this.orderSubmitting = true;
                
                try {
const res = await axios.post(`${API_BASE}/api/order`, {
                        userId: this.user.id,
                        productId: this.buyModal.prod.id,
                        paymentMethod: this.buyForm.method,
                        useBalance: this.buyForm.useBalance,
                        balanceAmount: this.buyForm.balanceAmount,
                        contactInfo: this.buyForm.contactInfo,
                        totalAmount: this.buyModal.prod.price,
                        cartItems: this.buyModal.prod.id === 'cart' ? this.cartItems : [], // ã€ä¿®å¤ã€‘å¿…é¡»ä¼ å…¥è´­ç‰©è½¦æ•°æ®
                        source: window.location.hostname, // ã€æ–°å¢ã€‘æ ‡è®°è®¢å•æ¥æº
                        shippingInfo: this.buyModal.prod.type === 'physical' ? {
                            name: this.buyForm.shipName,
                            tel: this.buyForm.shipTel,
                            addr: this.buyForm.shipAddr
                        } : {}
                    });

                    // 3. å¤„ç†å“åº”
                    if (res.data.success) {
                        this.buyModal.open = false;
if (res.data.status === 'å·²æ”¯ä»˜') {
                            // [ä¿®æ”¹] è¿™é‡Œçš„ 800 æ”¹æˆ 600000 (10åˆ†é’Ÿ)
                            if (!window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) {
                                setTimeout(() => {
                                    this.showAddToHomeGuide('purchase'); 
                                }, 600000);
                            }

                            Swal.fire({
                                icon: 'success',
                                title: 'æ”¯ä»˜æˆåŠŸ',
                                text: 'ä½™é¢æŠµæ‰£æˆåŠŸï¼Œæˆ‘ä»¬å°†å°½å¿«ä¸ºæ‚¨å‘è´§',
                                confirmButtonText: 'ç¡®å®š',
                                confirmButtonColor: '#10b981'
                            });
                            this.checkLoginAndGo('orders_page');
                            this.loadUserBalance();
                            return;
                        }

                        let msg = `è®¢å•åˆ›å»ºæˆåŠŸï¼<br>è®¢å•å·: <b>${res.data.orderId}</b><br>`;
                        let timerInterval; // å®šä¹‰è®¡æ—¶å™¨å˜é‡

                        // æ„å»ºå¼¹çª—å†…å®¹
                        if (this.buyForm.method === 'USDT') {
                            const randomCents = res.data.orderId.toString().slice(-2);
                            const randomDecimal = parseInt(randomCents) / 100;
                            const finalAmount = (parseFloat(res.data.usdtAmount) + randomDecimal).toFixed(2);
                            
                            msg += `
                                è¯·åœ¨ <b id="success-timer" class="text-red-500 font-mono text-lg">30:00</b> å†…å®Œæˆæ”¯ä»˜<br>
                                æ”¯ä»˜é‡‘é¢: <b style="color:#ef4444; font-size:1.2em;">${finalAmount} USDT</b><br>
                                <span style="font-size:10px; color:#666;">(å·²è‡ªåŠ¨åŒ…å«éšæœºå°æ•°ä»¥ä¾¿æ ¸å¯¹)</span><br>
                                æ”¯ä»˜åœ°å€ (TRC20): <br>
                                <div style="background:#f1f5f9; padding:10px; border:1px dashed #3b82f6; border-radius:4px; margin:5px 0; font-size:13px; font-weight:bold; cursor:pointer; word-break:break-all;" onclick="navigator.clipboard.writeText('${res.data.wallet}')">
                                    ${res.data.wallet}
                                    <div style="font-size:10px; color:#3b82f6; margin-top:4px;">ğŸ“‹ ç‚¹å‡»å¤åˆ¶åœ°å€</div>
                                </div>
                                <div style="background:#fffbeb; border:1px solid #fcd34d; padding:8px; border-radius:4px; margin-top:5px; font-size:12px; color:#b45309; text-align:left;">
                                    âš ï¸ <b>é‡è¦æç¤ºï¼š</b><br>
                                    1. å¿…é¡»æ”¯ä»˜ <b>${finalAmount}</b> æ‰èƒ½è‡ªåŠ¨åˆ°è´¦ã€‚<br>
                                    2. 30åˆ†é’Ÿå†…æœªæ”¯ä»˜è®¢å•å°†è‡ªåŠ¨è¿‡æœŸã€‚<br>
                                    3. å¤šå‡ºæ¥çš„å°æ•°ç‚¹æ˜¯ç³»ç»Ÿéšæœºç”Ÿæˆçš„ç”¨äºåŒºåˆ†è®¢å•æ˜¯å¦æ”¯ä»˜æˆåŠŸï¼Œæ”¯ä»˜åä¼šåˆ°ä½ çš„è´¦æˆ·ä½™é¢ï¼Œä¸‹æ¬¡å¯ä»¥ç»„åˆæ”¯ä»˜ä¹Ÿå¯ä»¥æç°ã€‚
                                </div>
                            `;
                        } else {
                            msg += `è¯·æ”¯ä»˜ <b>Â¥${res.data.cnyAmount}</b><br>è¯·è”ç³»å®¢æœè·å–æ”¶æ¬¾ç ï¼Œå¹¶å‘é€è®¢å•å· ${res.data.orderId}ã€‚`;
                        }

                        // å¼¹å‡ºæˆåŠŸçª—å£
                        await Swal.fire({
                            title: 'ä¸‹å•æˆåŠŸ',
                            html: msg,
                            icon: 'success',
                            confirmButtonText: 'æŸ¥çœ‹è®¢å•',
                            confirmButtonColor: '#3b82f6',
                            didOpen: () => {
                                const timerDisplay = document.getElementById('success-timer');
                                if (timerDisplay) {
                                    let timeLeft = 30 * 60; 
                                    timerInterval = setInterval(() => {
                                        timeLeft--;
                                        if (timeLeft < 0) {
                                            clearInterval(timerInterval);
                                            timerDisplay.textContent = "å·²è¿‡æœŸ";
                                        } else {
                                            const m = Math.floor(timeLeft / 60);
                                            const s = timeLeft % 60;
                                            timerDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                                        }
                                    }, 1000);
                                }
                            },
                            willClose: () => {
                                if (timerInterval) clearInterval(timerInterval);
                            }
                        });
                        
                        this.checkLoginAndGo('orders');
                        this.loadUserBalance();

                    } else {
                        Swal.fire('ä¸‹å•å¤±è´¥', res.data.msg, 'error');
                    }
                } catch (e) {
                    console.error(e);
                    Swal.fire('é”™è¯¯', 'ç½‘ç»œå¼‚å¸¸', 'error');
                } finally {
                    this.orderSubmitting = false;
                }
            },
            
            async cancelOrder(oid) {
                const result = await Swal.fire({
                    title: 'ç¡®å®šå–æ¶ˆè®¢å•?',
                    text: "å–æ¶ˆåæ— æ³•æ¢å¤",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#94a3b8',
                    confirmButtonText: 'ç¡®å®šå–æ¶ˆ',
                    cancelButtonText: 'è¿”å›'
                });

                if (result.isConfirmed) {
                    try {
                        const res = await axios.post(`${API_BASE}/api/order/cancel`, {
                            orderId: oid,
                            userId: this.user.id
                        });
                        if (res.data.success) {
                            Swal.fire({title:'å·²å–æ¶ˆ', icon:'success', timer:1000, showConfirmButton:false});
                            this.loadOrders();
                            this.loadUserBalance();
                        } else {
                            Swal.fire('å¤±è´¥', res.data.msg, 'error');
                        }
                    } catch (e) {
                        Swal.fire('é”™è¯¯', 'æ“ä½œå¤±è´¥', 'error');
                    }
                }
            },
            
            continueRecharge(item) {
                this.recordModal.open = false; // å…ˆå…³é—­è®°å½•å¼¹çª—ï¼Œé˜²æ­¢é®æŒ¡
                this.showPaymentInfo(item);    // è°ƒç”¨å·²æœ‰çš„æ”¯ä»˜è¯¦æƒ…å¼¹çª—
            },

            showPaymentInfo(order) {
                // å…ˆåˆ¤æ–­æ˜¯å¦è¿‡æœŸ
                if (this.isOrderExpired(order)) {
                   const randomCents = order.order_id.toString().slice(-2);
                    const displayAmount = (parseFloat(order.usdt_amount) + (parseInt(randomCents)/100)).toFixed(2);
                    let timerInterval;
                    Swal.fire({
                        title: 'USDT æ”¯ä»˜è¯¦æƒ…',
                        html: `
                            <div class="text-left">
                                <p class="mb-2">å¾…æ”¯ä»˜é‡‘é¢: <b class="text-red-600 text-xl">${displayAmount} USDT</b></p>
                                <p class="text-sm text-slate-500 mb-1">è¯·åœ¨ <b id="detail-timer" class="text-red-500 font-mono text-lg">--:--</b> å†…å®Œæˆæ”¯ä»˜</p>
                                <p class="text-sm text-slate-800 font-bold mb-1">TRC20 æ”¶æ¬¾åœ°å€:</p>
                                <div class="bg-slate-50 p-3 rounded text-sm break-all select-all border-2 border-dashed border-blue-200 mb-4 text-slate-800 font-bold cursor-pointer hover:bg-blue-50 transition" onclick="navigator.clipboard.writeText('${order.wallet}')">
                                    ${order.wallet}
                                    <div class="text-xs text-blue-500 mt-2 flex items-center justify-center gap-1"><i class="ri-file-copy-line"></i> ç‚¹å‡»å¤åˆ¶åœ°å€</div>
                                </div>
                                <div class="text-xs text-slate-600 bg-orange-50 p-3 rounded border border-orange-100 leading-relaxed">
                                    <strong>âš ï¸ æ”¯ä»˜å¿…è¯»ï¼š</strong><br>
                                    è¯·ä¸€å®šè¦ä»˜å‡†ç¡®çš„é‡‘é¢ <b>${displayAmount}</b> USDTã€‚<br>
                                    å¤šå‡ºæ¥çš„å°æ•°ç‚¹æ˜¯ç³»ç»Ÿéšæœºç”Ÿæˆçš„ç”¨äºåŒºåˆ†è®¢å•æ˜¯å¦æ”¯ä»˜æˆåŠŸï¼Œæ”¯ä»˜åä¼šåˆ°ä½ çš„è´¦æˆ·ä½™é¢ï¼Œä¸‹æ¬¡å¯ä»¥ç»„åˆæ”¯ä»˜ä¹Ÿå¯ä»¥æç°ã€‚
                                </div>
                            </div>
                        `,
                        confirmButtonText: 'æˆ‘å·²äº†è§£',
                        confirmButtonColor: '#3b82f6',
                        didOpen: () => {
                            const timerDisplay = document.getElementById('detail-timer');
                            const expires = new Date(order.expires_at).getTime();
                            timerInterval = setInterval(() => {
                                const now = new Date().getTime();
                                const distance = expires - now;
                                if (distance < 0) {
                                    clearInterval(timerInterval);
                                    if(timerDisplay) timerDisplay.textContent = "å·²è¿‡æœŸ";
                                } else {
                                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                                    if(timerDisplay) timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                }
                            }, 1000);
                        },
                        willClose: () => {
                            clearInterval(timerInterval);
                        }
                    });
                } else {
// å¦‚æœå·²ç»æœ‰äºŒç»´ç ï¼Œæ˜¾ç¤ºäºŒç»´ç å¼¹çª—
                    if (order.qrcode_url) {
                        let payMethodText = 'è¯·ä½¿ç”¨æ‰«ç æ”¯ä»˜';
                        if (order.payment_method === 'WeChat') payMethodText = 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»˜';
                        else if (order.payment_method === 'Alipay') payMethodText = 'è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«ç æ”¯ä»˜';

                        let timerInterval;

                        Swal.fire({
                            title: 'å®¢æœå·²ä¸Šä¼ æ”¶æ¬¾ç ',
                            // 1. ç¦ç”¨é»˜è®¤æ ·å¼ï¼Œä½¿ç”¨è‡ªå®šä¹‰ Class
                            buttonsStyling: false,
                            customClass: {
                                popup: 'rounded-2xl',
                                // ä½¿ç”¨åˆ†ç±»æŒ‰é’®çš„æ ·å¼ï¼šæ¸å˜è‰²
                                confirmButton: 'btn-gradient text-white shadow-lg shadow-indigo-500/20 ring-2 ring-indigo-50 px-6 py-2.5 rounded-full text-xs font-bold transition-all duration-300 transform hover:-translate-y-0.5 active:scale-95 m-1',
                                // ä½¿ç”¨åˆ†ç±»æŒ‰é’®çš„æœªé€‰ä¸­æ ·å¼ï¼šç™½è‰²èƒŒæ™¯
                                cancelButton: 'bg-white text-slate-500 hover:text-slate-800 border border-slate-200 hover:border-slate-300 px-6 py-2.5 rounded-full text-xs font-bold transition-all duration-300 transform hover:-translate-y-0.5 active:scale-95 m-1',
                                denyButton: 'bg-white text-slate-500 hover:text-slate-800 border border-slate-200 hover:border-slate-300 px-6 py-2.5 rounded-full text-xs font-bold transition-all duration-300 transform hover:-translate-y-0.5 active:scale-95 m-1'
                            },
                            html: `
                                <div class="text-center">
                                    <div class="mb-3 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                        <span class="text-xs text-slate-400 block">è´­ä¹°å•†å“</span>
                                        <span class="text-sm font-bold text-slate-800 line-clamp-1">${order.product_name}</span>
                                    </div>

                                    <p class="mb-2 text-xs text-slate-500">è®¢å•å·: ${order.order_id}</p>
                                    <p class="text-red-500 font-bold mb-4">è¯·åœ¨ <b id="qr-timer">--:--</b> å†…å®Œæˆæ”¯ä»˜</p>
                                    <img src="${order.qrcode_url}" style="max-width:200px; margin:0 auto; border:1px solid #eee; border-radius:8px; padding:5px;">
                                    <p class="mt-3 text-sm text-slate-500">${payMethodText}</p>
                                    <p class="mt-1 text-lg font-bold text-brand-600">Â¥${order.cny_amount}</p>
                                </div>
                            `,
                            icon: 'info',
                            confirmButtonText: 'æˆ‘å·²æ”¯ä»˜ï¼Œå»ä¸Šä¼ å‡­è¯',
                            showCancelButton: true,
                            cancelButtonText: 'ç¨åæ”¯ä»˜',
                            showDenyButton: true,
                            denyButtonText: 'äºŒç»´ç æ— æ³•è¯†åˆ«', 
                            allowOutsideClick: false,
                            // --- æ ¸å¿ƒä¿®å¤ï¼šå€’è®¡æ—¶é€»è¾‘ ---
                            didOpen: () => {
                                const timerDisplay = document.getElementById('qr-timer');
                                const expires = new Date(order.expires_at).getTime();
                                
                                timerInterval = setInterval(() => {
                                    const now = new Date().getTime();
                                    const distance = expires - now;

                                    if (distance < 0) {
                                        clearInterval(timerInterval);
                                        if(timerDisplay) timerDisplay.textContent = "å·²è¿‡æœŸ";
                                        Swal.close(); // è¿‡æœŸè‡ªåŠ¨å…³é—­å¼¹çª—
                                    } else {
                                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                                        if(timerDisplay) timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                    }
                                }, 1000);
                            },
                            willClose: () => {
                                clearInterval(timerInterval);
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                this.confirmPayment(order.order_id);
                            } else if (result.isDenied) {
                                this.reportQrIssue(order.order_id);
                            }
                        });
                    }
                           else {
                        // æ²¡æœ‰äºŒç»´ç æ—¶æ˜¾ç¤ºåŸæ¥çš„æç¤º
                        Swal.fire({
                            title: 'ç­‰å¾…æ”¶æ¬¾ç ',
                            text: `éœ€æ”¯ä»˜ Â¥${order.cny_amount}ã€‚è¯·è”ç³»å®¢æœè·å–æ”¶æ¬¾ç ï¼Œå¹¶å‘é€è®¢å•å· ${order.order_id}ã€‚`,
                            icon: 'info',
                            confirmButtonColor: '#3b82f6'
                        });
                    }
                }
            },
            
            // å……å€¼åŠŸèƒ½
            openRechargeModal() {
                if (!this.user.id) return this.openAuth('login');
                history.pushState({ modal: 'recharge' }, null, '');
                this.rechargeModal.open = true;
                this.rechargeForm = { amount: 10, method: 'USDT' };
            },
            
            async submitRecharge() {
                if (!this.rechargeForm.amount || this.rechargeForm.amount <= 0) {
                    return Swal.fire('æç¤º', 'è¯·è¾“å…¥æ­£ç¡®çš„å……å€¼é‡‘é¢', 'warning');
                }

                this.rechargeSubmitting = true;
                try {
                    const res = await axios.post(`${API_BASE}/api/recharge`, {
                        userId: this.user.id,
                        amount: this.rechargeForm.amount,
                        method: this.rechargeForm.method
                    });

                    if (res.data.success) {
                        this.rechargeModal.open = false;
                        
                        let msg = `å……å€¼è®¢å•åˆ›å»ºæˆåŠŸï¼<br>è®¢å•å·: <b>${res.data.orderId}</b><br>`;
                        if (this.rechargeForm.method === 'USDT') {
                            msg += `
                                è¯·åœ¨ <b class="order-timer">30:00</b> å†…å®Œæˆæ”¯ä»˜<br>
                                æ”¯ä»˜é‡‘é¢: <b style="color:#2563eb">${res.data.usdtAmount} USDT</b><br>
                                æ”¯ä»˜åœ°å€: <br>
                                <div style="background:#f1f5f9; padding:8px; border-radius:4px; margin:5px 0; font-family:monospace; font-size:12px; cursor:pointer;" onclick="navigator.clipboard.writeText('${res.data.wallet}')">
                                    ${res.data.wallet}
                                    <div style="font-size:10px; color:#64748b;">ç‚¹å‡»å¤åˆ¶åœ°å€</div>
                                </div>
                            `;
                        } else {
                            msg += `è¯·æ”¯ä»˜ <b>Â¥${res.data.cnyAmount}</b><br>è¯·è”ç³»å®¢æœè·å–æ”¶æ¬¾ç ï¼Œå¹¶å‘é€è®¢å•å· ${res.data.orderId}ã€‚`;
                        }

                        Swal.fire({
                            title: 'å……å€¼æˆåŠŸ',
                            html: msg,
                            icon: 'success',
                            confirmButtonText: 'ç¡®å®š',
                            confirmButtonColor: '#3b82f6'
                        });
                        
                        this.loadUserBalance();
                    } else {
                        Swal.fire('å……å€¼å¤±è´¥', res.data.msg, 'error');
                    }
                } catch (e) {
                    Swal.fire('é”™è¯¯', 'ç½‘ç»œå¼‚å¸¸', 'error');
                } finally {
                    this.rechargeSubmitting = false;
                }
            },
            
            // æç°åŠŸèƒ½
            openWithdrawModal() {
                if (!this.user.id) return this.openAuth('login');
                if ((this.user.balance || 0) < 1) {
                    return Swal.fire('æç¤º', 'ä½™é¢ä¸è¶³1 USDTï¼Œæ— æ³•æç°', 'warning');
                }
                history.pushState({ modal: 'withdraw' }, null, '');
                this.withdrawModal.open = true;
                this.withdrawForm = { amount: Math.min(this.user.balance || 0, 10), address: '' };
            },
            
            handleWithdrawFile(event) {
                const file = event.target.files[0];
                if(file) {
                    this.withdrawForm.file = file;
                    this.withdrawForm.preview = URL.createObjectURL(file);
                }
            },

            async submitWithdraw() {
                if (!this.withdrawForm.amount || this.withdrawForm.amount < 5) {
                    return Swal.fire('æç¤º', 'æœ€å°æç°é‡‘é¢ä¸º 5 USDT', 'warning');
                }
                if (this.withdrawForm.amount > (this.user.balance || 0)) {
                    return Swal.fire('æç¤º', 'æç°é‡‘é¢ä¸èƒ½è¶…è¿‡ä½™é¢', 'warning');
                }
                
                if (this.withdrawForm.method === 'USDT') {
                    if(!this.withdrawForm.address || this.withdrawForm.address.length < 10) return Swal.fire('æç¤º', 'è¯·è¾“å…¥æ­£ç¡®çš„USDTåœ°å€', 'warning');
                    if(!this.withdrawForm.confirmAddr) return Swal.fire('æç¤º', 'è¯·å‹¾é€‰ç¡®è®¤åœ°å€æ­£ç¡®', 'warning');
                } else {
                    if(!this.withdrawForm.file) return Swal.fire('æç¤º', 'è¯·ä¸Šä¼ æ”¶æ¬¾ç å›¾ç‰‡', 'warning');
                }

                this.withdrawSubmitting = true;
                try {
                    const formData = new FormData();
                    formData.append('userId', this.user.id);
                    formData.append('amount', this.withdrawForm.amount);
                    formData.append('method', this.withdrawForm.method);
                    formData.append('address', this.withdrawForm.address || '');
                    if(this.withdrawForm.file) {
                        formData.append('file', this.withdrawForm.file);
                    }

                    const res = await axios.post(`${API_BASE}/api/withdraw`, formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });

                    if (res.data.success) {
                        this.withdrawModal.open = false;
                        Swal.fire({
                            title: 'æç°ç”³è¯·å·²æäº¤',
                            text: 'å®¢æœç¨åä¼šå¤„ç†è¯·ç¨ç­‰',
                            icon: 'success',
                            confirmButtonColor: '#3b82f6'
                        });
                        this.loadUserBalance();
                    } else {
                        Swal.fire('æç°å¤±è´¥', res.data.msg, 'error');
                    }
                } catch (e) {
                    Swal.fire('é”™è¯¯', 'ç½‘ç»œå¼‚å¸¸', 'error');
                } finally {
                    this.withdrawSubmitting = false;
                }
            },
            
            // æ”¯ä»˜å‡­è¯
            confirmPayment(orderId) {
                this.paymentProofModal.open = true;
                this.paymentProofModal.orderId = orderId;
                this.paymentProofModal.proofUrl = '';
            },
            
           handlePaymentProof(event) {
                const file = event.target.files[0];
                if (file) {
                    this.paymentProofModal.file = file; 
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.paymentProofModal.proofUrl = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },
            
            async submitPaymentProof() {
                if (!this.paymentProofModal.file) {
                    return Swal.fire('æç¤º', 'è¯·ä¸Šä¼ æ”¯ä»˜å‡­è¯', 'warning');
                }

                this.paymentProofSubmitting = true;
                try {
                    const formData = new FormData();
                    formData.append('orderId', this.paymentProofModal.orderId);
                    formData.append('userId', this.user.id);
                    formData.append('file', this.paymentProofModal.file);

                    const res = await axios.post(`${API_BASE}/api/order/confirm-payment`, formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });

                    if (res.data.success) {
                        this.paymentProofModal.open = false;
                        this.paymentProofModal.file = null;
                        this.paymentProofModal.proofUrl = '';
                        
                        Swal.fire({
                            title: 'æäº¤æˆåŠŸ',
                            text: 'å®¢æœç¨åä¼šæ ¸å®ä½ çš„æ”¯ä»˜å‡­è¯',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        this.loadOrders();
                    } else {
                        Swal.fire('æäº¤å¤±è´¥', res.data.msg, 'error');
                    }
                } catch (e) {
                    console.error(e);
                    Swal.fire('é”™è¯¯', 'ç½‘ç»œå¼‚å¸¸', 'error');
                } finally {
                    this.paymentProofSubmitting = false;
                }
            },
            
            reportQrIssue(orderId) {
                Swal.fire({
                    title: 'äºŒç»´ç å¼‚å¸¸',
                    text: 'å·²é€šçŸ¥å®¢æœï¼Œè¯·ç¨ååˆ·æ–°é¡µé¢æŸ¥çœ‹æ–°çš„äºŒç»´ç ',
                    icon: 'warning',
                    confirmButtonColor: '#3b82f6'
                });
                
                // å‘é€é€šçŸ¥åˆ°åå°
                axios.post(`${API_BASE}/api/order/report-qr-issue`, {
                    orderId: orderId,
                    userId: this.user.id
                }).catch(() => {});
            },
            
            // å¯†ç ä¿®æ”¹
            async changePassword() {
                if (!this.securityForm.oldPassword) {
                    return Swal.fire('æç¤º', 'è¯·è¾“å…¥æ—§å¯†ç ', 'warning');
                }
                if (!this.securityForm.newPassword) {
                    return Swal.fire('æç¤º', 'è¯·è¾“å…¥æ–°å¯†ç ', 'warning');
                }
                if (this.securityForm.newPassword.length < 6) {
                    return Swal.fire('æç¤º', 'æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'warning');
                }
                if (this.securityForm.newPassword !== this.securityForm.confirmPassword) {
                    return Swal.fire('æç¤º', 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'warning');
                }

                try {
                    const res = await axios.post(`${API_BASE}/api/user/change-password`, {
                        userId: this.user.id,
                        oldPassword: this.securityForm.oldPassword,
                        newPassword: this.securityForm.newPassword
                    });

                    if (res.data.success) {
                        Swal.fire({
                            title: 'ä¿®æ”¹æˆåŠŸ',
                            text: 'å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•',
                            icon: 'success',
                            confirmButtonColor: '#3b82f6'
                        }).then(() => {
                            this.logout();
                        });
                    } else {
                        Swal.fire('ä¿®æ”¹å¤±è´¥', res.data.msg, 'error');
                    }
} catch (e) {
                    Swal.fire('é”™è¯¯', 'ç½‘ç»œå¼‚å¸¸', 'error');
                }
            },

            async submitRestock(prod) {
                if(!this.restockContact) return Swal.fire('æç¤º', 'è¯·å¡«å†™è”ç³»æ–¹å¼', 'warning');
                try {
                    await axios.post(`${API_BASE}/api/notify-restock`, {
                        productName: prod.name,
                        contact: this.restockContact
                    });
                    Swal.fire('å·²ç™»è®°', 'è¡¥è´§åå®¢æœä¼šç¬¬ä¸€æ—¶é—´è”ç³»æ‚¨', 'success');
                    this.restockContact = '';
                } catch(e) { Swal.fire('é”™è¯¯', 'æäº¤å¤±è´¥', 'error'); }
            },
            
            // è´­ç‰©è½¦åŠŸèƒ½
            addToCart(prod) {
                const existingItem = this.cartItems.find(item => item.id === prod.id);
                if (existingItem) {
                    existingItem.quantity = (existingItem.quantity || 1) + 1;
                } else {
                    this.cartItems.push({
                        ...prod,
                        quantity: 1
                    });
                }
                localStorage.setItem('nexus_cart', JSON.stringify(this.cartItems));
                
                Swal.fire({
                    icon: 'success',
                    title: 'å·²åŠ å…¥è´­ç‰©è½¦',
                    timer: 1000,
                    showConfirmButton: false
                });
            },
            
            removeFromCart(item) {
                this.cartItems = this.cartItems.filter(cartItem => cartItem.id !== item.id);
                localStorage.setItem('nexus_cart', JSON.stringify(this.cartItems));
            },
            
            updateCartQuantity(item, delta) {
                const newQuantity = (item.quantity || 1) + delta;
                if (newQuantity < 1) {
                    this.removeFromCart(item);
                } else {
                    item.quantity = newQuantity;
                    localStorage.setItem('nexus_cart', JSON.stringify(this.cartItems));
                }
            },
            
            clearCart() {
                Swal.fire({
                    title: 'æ¸…ç©ºè´­ç‰©è½¦ï¼Ÿ',
                    text: "è¿™å°†åˆ é™¤è´­ç‰©è½¦ä¸­çš„æ‰€æœ‰å•†å“",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#94a3b8',
                    confirmButtonText: 'æ¸…ç©º',
                    cancelButtonText: 'å–æ¶ˆ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.cartItems = [];
                        localStorage.setItem('nexus_cart', JSON.stringify(this.cartItems));
                    }
                });
            },
            
            viewCart() {
                if (!this.user.id) return this.openAuth('login');
                this.view = 'cart';
            },
            
            checkoutCart() {
                if (this.cartItems.length === 0) return;
                
                const hasPhysical = this.cartItems.some(item => item.type === 'physical');
                const totalAmount = this.cartTotal;
                
                const itemNames = this.cartItems.map(item => `${item.name} x${item.quantity||1}`).join(' | ');

                this.buyModal.prod = {
                    id: 'cart',
                    name: itemNames,
                    price: totalAmount,
                    type: hasPhysical ? 'physical' : 'virtual',
                    description: itemNames
                };
                this.buyModal.open = true;
                this.buyForm = { 
                    method: 'USDT', 
                    shipName: '', 
                    shipTel: '', 
                    shipAddr: '',
                    useBalance: false,
                    balanceAmount: 0,
                    contactInfo: ''
                };
            },
            
            // è®¢å•å€’è®¡æ—¶
            startOrderTimers() {
                // æ¸…é™¤ç°æœ‰è®¡æ—¶å™¨
                Object.values(this.orderTimers).forEach(timer => clearInterval(timer));
                this.orderTimers = {};
                
                // ä¸ºæ¯ä¸ªå¾…æ”¯ä»˜è®¢å•å¯åŠ¨è®¡æ—¶å™¨
                this.myOrders
                    .filter(order => order.status === 'å¾…æ”¯ä»˜' && order.expires_at)
                    .forEach(order => {
                        this.orderTimers[order.order_id] = setInterval(() => {
                            this.updateOrderTimer(order.order_id);
                        }, 1000);
                    });
            },
            
           updateOrderTimer(orderId) {
                const order = this.myOrders.find(o => o.order_id === orderId);
                if (!order) {
                    clearInterval(this.orderTimers[orderId]);
                    return;
                }
                
                if (order.status !== 'å¾…æ”¯ä»˜') {
                    clearInterval(this.orderTimers[orderId]);
                    return;
                }
                
                const now = new Date().getTime();
                const expires = new Date(order.expires_at).getTime();
                let diff = expires - now;

                if (!order.expires_at) {
                    order.countdown_text = "ç­‰å¾…æ”¶æ¬¾ç ";
                    order.is_expired = false;
                    return; 
                }

                if (diff <= 0) {
                    order.countdown_text = "å·²è¿‡æœŸ";
                    order.is_expired = true;
                    clearInterval(this.orderTimers[orderId]);
                } else {
                    order.is_expired = false;
                    const minutes = Math.floor(diff / 1000 / 60);
                    const seconds = Math.floor((diff / 1000) % 60);
                    order.countdown_text = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            },
            
            formatCountdown(expiresAt) {
                if (!expiresAt) return '--:--';
                const now = new Date();
                const expires = new Date(expiresAt);
                const diff = expires - now;
                
                if (diff <= 0) return 'å·²è¿‡æœŸ';
                
                const minutes = Math.floor(diff / 1000 / 60);
                const seconds = Math.floor((diff / 1000) % 60);
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },
            
            formatDate(str) {
                return new Date(str).toLocaleString();
            },
            
getTelegramLink(contact) {
                if (!contact) return '#';
                const username = contact.replace('@', '');
                return `https://t.me/${username}`;
            },

            // æ‰“å¼€é‚€è¯·æ—¶åŠ è½½æ•°æ®
            async openInviteModal() {
                this.inviteModal.open = true;
                if(this.user.id) {
                    try {
                        const res = await axios.get(`${API_BASE}/api/user/team?userId=${this.user.id}`);
                        if(res.data.success) {
                            this.inviteModal.list = res.data.list;
                            this.inviteModal.totalEarned = res.data.total;
                        }
                    } catch(e){}
                }
            },

            async openBalanceLogs() {
                if (!this.user.id) return this.openAuth('login');
                this.balanceLogModal.open = true;
                this.balanceLogModal.loading = true;
                try {
                    const res = await axios.get(`${API_BASE}/api/user/balance_logs?userId=${this.user.id}`);
                    this.balanceLogModal.list = res.data || [];
                } catch(e) {
                    this.balanceLogModal.list = [];
                } finally {
                    this.balanceLogModal.loading = false;
                }
            },

            async openRecordModal(type) {
                if (!this.user.id) return this.openAuth('login');
                
                this.recordModal.type = type;
                this.recordModal.title = type === 'recharge' ? 'å……å€¼è®°å½•' : 'æç°è®°å½•';
                this.recordModal.list = []; 
                this.recordModal.loading = true;
                this.recordModal.open = true; 
                
               try {
                    const res = await axios.get(`${API_BASE}/api/user/records?userId=${this.user.id}&type=${type}`);
                    this.recordModal.list = Array.isArray(res.data) ? res.data : [];
                } catch(e) {
                    console.error(e);
                    this.recordModal.list = [];
                } finally {
                    this.recordModal.loading = false;
                }
            },
            
            openWalletAction(type) {
                if (type === 'recharge') {
                    this.openRechargeModal();
                } else {
                    this.openWithdrawModal();
                }
            },

async pollUpdates() {
                try {
                    const publicRes = await axios.get(`${API_BASE}/api/public/data`);
                    const d = publicRes.data;
                    this.products = d.products || [];
                    this.settings.rate = d.rate;
                    this.settings.feeRate = d.feeRate;
                    this.settings.announcement = d.announcement;
                } catch (e) {}

                if (!this.user.id) return;

                try {
                    const balanceRes = await axios.get(`${API_BASE}/api/user/balance?userId=${this.user.id}`);
                    if (balanceRes.data.success) {
                        this.user.balance = balanceRes.data.balance;
                        localStorage.setItem('nexus_user', JSON.stringify(this.user));
                    }

                    const ordersRes = await axios.get(`${API_BASE}/api/order?userId=${this.user.id}`);
                    const newOrders = ordersRes.data || [];

                    // [æ–°å¢] æ£€æµ‹æ˜¯å¦æœ‰è®¢å•åˆšåˆšå˜æˆäº†"å·²æ”¯ä»˜"
                    // é€»è¾‘ï¼šéå†æ–°è®¢å•ï¼Œå¦‚æœåœ¨è€æ•°æ®é‡Œæ˜¯"å¾…æ”¯ä»˜"ï¼Œä½†åœ¨æ–°æ•°æ®é‡Œæ˜¯"å·²æ”¯ä»˜"ï¼Œè¯´æ˜åˆšåˆšåˆ°è´¦
                    if (this.myOrders.length > 0) {
                        for (const newOrder of newOrders) {
                            const oldOrder = this.myOrders.find(o => o.order_id === newOrder.order_id);
                            // å¦‚æœæ‰¾åˆ°äº†æ—§è®¢å•ï¼Œä¸”æ—§çŠ¶æ€ä¸æ˜¯å·²æ”¯ä»˜ï¼Œæ–°çŠ¶æ€æ˜¯å·²æ”¯ä»˜
                           if (oldOrder && oldOrder.status !== 'å·²æ”¯ä»˜' && newOrder.status === 'å·²æ”¯ä»˜') {
                                // æ’­æ”¾æç¤ºéŸ³
                                this.messageSound.play().catch(()=>{});
                                Swal.fire({ icon: 'success', title: 'æ”¯ä»˜æˆåŠŸ', text: 'æ‚¨çš„è®¢å•å·²åˆ°è´¦ï¼', timer: 2000, showConfirmButton: false });
                                
                                // å¼¹å‡ºå®‰è£…å¼•å¯¼
                                if (!window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) {
                                    // [ä¿®æ”¹] è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼š10åˆ†é’Ÿ = 600000 æ¯«ç§’
                                    setTimeout(() => {
                                        this.showAddToHomeGuide('purchase');
                                    }, 600000); 
                                }
                                break; // åªå¼¹ä¸€æ¬¡ï¼Œé¿å…å¤šä¸ªè®¢å•åŒæ—¶åˆ°è´¦å¼¹çª—é‡å 
                            }
                        }
                    }
                    
                    this.myOrders = newOrders;
                    this.startOrderTimers(); 

                    // 3. æ£€æµ‹äºŒç»´ç å¹¶å¼¹çª—
                    for (const order of newOrders) {
                        if (order.status === 'å¾…æ”¯ä»˜' && order.qrcode_url && !this.notifiedQRCodes.includes(order.order_id) && !this.isOrderExpired(order)) {
                            
                            this.notifiedQRCodes.push(order.order_id); 
                            sessionStorage.setItem('notified_qrs', JSON.stringify(this.notifiedQRCodes));
                            
                            let payMethodText = 'è¯·ä½¿ç”¨æ‰«ç æ”¯ä»˜';
                            if (order.payment_method === 'WeChat') payMethodText = 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»˜';
                            else if (order.payment_method === 'Alipay') payMethodText = 'è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«ç æ”¯ä»˜';

                            let timerInterval;

                            Swal.fire({
                                title: 'å®¢æœå·²ä¸Šä¼ æ”¶æ¬¾ç ',
                                html: `
                                    <div class="text-center">
                                        <p class="mb-2">è®¢å•å·: <b>${order.order_id}</b></p>
                                        <p class="text-red-500 font-bold mb-4">è¯·åœ¨ <b id="qr-timer">--:--</b> å†…å®Œæˆæ”¯ä»˜</p>
                                        <img src="${order.qrcode_url}" style="max-width:200px; margin:0 auto; border:1px solid #eee; border-radius:8px; padding:5px;">
                                        <p class="mt-3 text-sm text-slate-500">${payMethodText}</p>
                                        <p class="mt-1 text-lg font-bold text-brand-600">Â¥${order.cny_amount}</p>
                                    </div>
                                `,
                                icon: 'info',
                                confirmButtonText: 'æˆ‘å·²æ”¯ä»˜ï¼Œå»ä¸Šä¼ å‡­è¯',
                                showCancelButton: true,
                                cancelButtonText: 'ç¨åæ”¯ä»˜',
                                 showDenyButton: true,
                                denyButtonText: 'äºŒç»´ç æ— æ³•è¯†åˆ«', 
                                confirmButtonColor: '#3b82f6',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    const timerDisplay = document.getElementById('qr-timer');
                                    const expires = new Date(order.expires_at).getTime();
                                    
                                    timerInterval = setInterval(() => {
                                        const now = new Date().getTime();
                                        const distance = expires - now;

                                        if (distance < 0) {
                                            clearInterval(timerInterval);
                                            if(timerDisplay) timerDisplay.textContent = "å·²è¿‡æœŸ";
                                            Swal.close(); // è¿‡æœŸè‡ªåŠ¨å…³é—­å¼¹çª—
                                        } else {
                                            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                                            if(timerDisplay) timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                        }
                                    }, 1000);
                                },
                                willClose: () => {
                                    clearInterval(timerInterval);
                                }
                           }).then((result) => {
                                if (result.isConfirmed) {
                                    this.paymentProofModal.orderId = order.order_id;
                                    this.paymentProofModal.proofUrl = '';
                                    this.paymentProofModal.file = null;
                                    this.paymentProofModal.open = true;
                                } else if (result.isDenied) {
                                    this.reportQrIssue(order.order_id);
                                }
                            });
                        }
                    }

                } catch (e) {
                    // é™é»˜å¤±è´¥
                }
            },
        }
    }).mount('#app')
</script>
</body>
</html>
